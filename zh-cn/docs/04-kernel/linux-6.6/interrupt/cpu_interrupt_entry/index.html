<!doctype html>
<html class="position-relative" itemscope itemtype="https://schema.org/WebPage" lang="zh-cn"
  data-bs-theme="auto" data-palette="purple">
  <head><script src="/assets/init/bundle.min.17bb1d3aa57be1ea17bd5f48fa2a59b44cab5fd5291efdf44dad530987335a4a.js" integrity="sha256-F7sdOqV74eoXvV9I&#43;ipZtEyrX9UpHv30Ta1TCYczWko=" crossorigin="anonymous"></script>
<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ARM64 Linux中断入口 - kingdix10&#39;s site</title>
    <link rel="icon" href="/favicon_hue47f7bc6656f0d7127c2215d260e644f_15816_16x16_resize_box_3.png" sizes="16x16" type="image/png">
    <link rel="icon" href="/favicon_hue47f7bc6656f0d7127c2215d260e644f_15816_32x32_resize_box_3.png" sizes="32x32" type="image/png">
    <link rel="icon" href="/favicon_hue47f7bc6656f0d7127c2215d260e644f_15816_150x150_resize_box_3.png" sizes="150x150" type="image/png">
    <link rel="apple-touch-icon" href="/favicon_hue47f7bc6656f0d7127c2215d260e644f_15816_180x180_resize_box_3.png" sizes="180x180" type="image/png">
    <link rel="icon" href="/favicon_hue47f7bc6656f0d7127c2215d260e644f_15816_192x192_resize_box_3.png" sizes="192x192" type="image/png">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#6f42c1">
<meta name="keywords" content="中断管理" />
  <meta name="description" content="1. 简介 ARM64中断入口相关的代码主要在arch/arm64/kernel/entry.S，启动过程中，会将中断向量表vectors的起始虚" />
    <meta name="robots" content="index, follow" /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://kingdix10.github.io/covers/lens_camera_glare_147903_300x168.jpg"/>

<meta name="twitter:title" content="ARM64 Linux中断入口"/>
<meta name="twitter:description" content="1. 简介 ARM64中断入口相关的代码主要在arch/arm64/kernel/entry.S，启动过程中，会将中断向量表vectors的起始虚"/>
<meta property="og:title" content="ARM64 Linux中断入口" />
<meta property="og:description" content="1. 简介 ARM64中断入口相关的代码主要在arch/arm64/kernel/entry.S，启动过程中，会将中断向量表vectors的起始虚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kingdix10.github.io/zh-cn/docs/04-kernel/linux-6.6/interrupt/cpu_interrupt_entry/" /><meta property="og:image" content="https://kingdix10.github.io/covers/lens_camera_glare_147903_300x168.jpg" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2024-04-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-04-20T00:00:00+00:00" /><meta property="og:site_name" content="kingdix10&#39;s site" />

<meta itemprop="name" content="ARM64 Linux中断入口">
<meta itemprop="description" content="1. 简介 ARM64中断入口相关的代码主要在arch/arm64/kernel/entry.S，启动过程中，会将中断向量表vectors的起始虚"><meta itemprop="datePublished" content="2024-04-20T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-04-20T00:00:00+00:00" />
<meta itemprop="wordCount" content="8078"><meta itemprop="image" content="https://kingdix10.github.io/covers/lens_camera_glare_147903_300x168.jpg">
<meta itemprop="keywords" content="Linux内核,linux-6.6," />
  <meta property="og:image:alt" content="ARM64 Linux中断入口" />
  <meta name="twitter:image:alt" content="ARM64 Linux中断入口" />
  <link rel="manifest" href="/zh-cn/manifest.json">

<link data-precache rel="stylesheet" href="/assets/main/bundle.min.03fda061e9fca038de4b9a0a9f07d0f48b8bb6231de98a9cf415bf6818d719cd.css" integrity="sha256-A/2gYen8oDjeS5oKnwfQ9IuLtiMd6Yqc9BW/aBjXGc0=" crossorigin="anonymous">

    <link data-precache rel="stylesheet" href="/assets/viewer/bundle.min.8c1002839fa22c1350d6ae1eef6593120e108f973c41348be9b5065430566aaf.css" integrity="sha256-jBACg5&#43;iLBNQ1q4e72WTEg4Qj5c8QTSL6bUGVDBWaq8=" crossorigin="anonymous">


</head>
  <body><header class="mb-4 sticky-top">
  
<nav class="top-app-bar shadow navbar navbar-expand-xxl">
  <div class="container">
    <button class="navbar-toggler border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDocsNav"
      aria-expanded="false" aria-label="Toggle docs navigation">
      <i class="fas fa-bars"></i>
    </button>
<a class="navbar-brand d-flex align-items-center flex-grow-1 flex-xxl-grow-0 justify-content-xxl-start justify-content-center ms-2 ms-xxl-0 mx-auto me-xxl-2"
    href="https://kingdix10.github.io/zh-cn/">
    <picture><img class="logo " alt="Logo" src="https://kingdix10.github.io/images/icon_yellow_transparent_72x72.png" loading="lazy" width="72" height="72" />
</picture>
kingdix10
</a>

    <div class="offcanvas-xxl offcanvas-end flex-grow-1" data-bs-scroll="true" tabindex="-1" id="navbarMenus" aria-labelledby="navbarMenusLabel">
      <div class="offcanvas-header px-4 pb-0">
        <div class="offcanvas-title h5" id="navbarMenusLabel">kingdix10</div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" data-bs-target="#navbarMenus" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body p-4 pt-0 p-xxl-0">
        <hr class="d-xxl-none">
        <ul class="navbar-nav flex-row flex-wrap align-items-center me-auto"><li class="nav-item col-6 col-xxl-auto">
            <a class="nav-link py-2 px-0 px-xxl-2" href="https://kingdix10.github.io/zh-cn">
<span class="menu-icon me-1"><i class="fas fa-home"></i></span>主页
            </a>
          </li><li class="nav-item col-6 col-xxl-auto">
            <a class="nav-link py-2 px-0 px-xxl-2" href="https://kingdix10.github.io/zh-cn/news/">
<span class="menu-icon me-1"><i class="fas fa-fw fa-newspaper"></i></span>新闻
            </a>
          </li><li class="nav-item col-6 col-xxl-auto">
            <a class="nav-link py-2 px-0 px-xxl-2" href="https://kingdix10.github.io/zh-cn/docs/">
<span class="menu-icon me-1"><i class="fas fa-fw fa-folder"></i></span>文档
            </a>
          </li>
          <li class="nav-item col-12 col-xxl-auto dropdown px-0">
            <a href="#"
              class="nav-link dropdown-toggle"
              id="navbarDropdownBlog" role="button" data-bs-toggle="dropdown" aria-expanded="false">
<span class="menu-icon me-1"><i class="fas fa-fw fa-blog"></i></span>博客
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownBlog" data-bs-popper="none">
              <li>
                <a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap"
                  href="https://kingdix10.github.io/zh-cn/archives/">
                    <span class="dropdown-item-icon me-2 p-2 rounded">
                      <i class="fas fa-fw fa-file-archive text-primary"></i>
                    </span>
                  <div class="dropdown-item-content">
                    <p class="dropdown-item-title mb-0">归档</p>
                  </div></a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap"
                  href="https://kingdix10.github.io/zh-cn/series/">
                    <span class="dropdown-item-icon me-2 p-2 rounded">
                      <i class="fas fa-fw fa-columns"></i>
                    </span>
                  <div class="dropdown-item-content">
                    <p class="dropdown-item-title mb-1">专栏</p>
                      <p class="dropdown-item-description mb-0 text-secondary">List of series.</p>
                  </div></a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap"
                  href="https://kingdix10.github.io/zh-cn/categories/">
                    <span class="dropdown-item-icon me-2 p-2 rounded">
                      <i class="fas fa-fw fa-folder text-success"></i>
                    </span>
                  <div class="dropdown-item-content">
                    <p class="dropdown-item-title mb-1">分类</p>
                      <p class="dropdown-item-description mb-0 text-secondary">List of categories.</p>
                  </div></a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap"
                  href="https://kingdix10.github.io/zh-cn/tags/">
                    <span class="dropdown-item-icon me-2 p-2 rounded">
                      <i class="fas fa-fw fa-tags"></i>
                    </span>
                  <div class="dropdown-item-content">
                    <p class="dropdown-item-title mb-1">标签</p>
                      <p class="dropdown-item-description mb-0 text-secondary">List of tags.</p>
                  </div></a>
              </li>
            </ul>
          </li>
          <li class="nav-item col-12 col-xxl-auto dropdown px-0">
            <a href="#"
              class="nav-link dropdown-toggle"
              id="navbarDropdownLinks" role="button" data-bs-toggle="dropdown" aria-expanded="false">
<span class="menu-icon me-1"><i class="fas fa-fw fa-link"></i></span>链接
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownLinks" data-bs-popper="none">
              <li>
                <a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap"
                  href="https://github.com/kingdix10" target="_blank" rel="noopener noreferrer">
                    <span class="dropdown-item-icon me-2 p-2 rounded">
                      <i class="fab fa-fw fa-github text-primary"></i>
                    </span>
                  <div class="dropdown-item-content">
                    <p class="dropdown-item-title mb-1">GitHub</p>
                      <p class="dropdown-item-description mb-0 text-secondary">github.com/kingdix10</p>
                  </div></a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap"
                  href="https://gitee.com/kingdix10" target="_blank" rel="noopener noreferrer">
                    <span class="dropdown-item-icon me-2 p-2 rounded">
                      <i class="fab fa-fw fa-github text-primary"></i>
                    </span>
                  <div class="dropdown-item-content">
                    <p class="dropdown-item-title mb-1">Gitee</p>
                      <p class="dropdown-item-description mb-0 text-secondary">gitee.com/kingdix10</p>
                  </div></a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap"
                  href="https://www.zhihu.com/people/kingdix10" target="_blank" rel="noopener noreferrer">
                    <span class="dropdown-item-icon me-2 p-2 rounded">
                      <i class="fab fa-fw fa-zhihu text-primary"></i>
                    </span>
                  <div class="dropdown-item-content">
                    <p class="dropdown-item-title mb-0">Zhihu</p>
                  </div></a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap"
                  href="https://www.cnblogs.com/kingdix10" target="_blank" rel="noopener noreferrer">
                  <div class="dropdown-item-content">
                    <p class="dropdown-item-title mb-0">博客园</p>
                  </div></a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap"
                  href="https://blog.csdn.net/u014001096" target="_blank" rel="noopener noreferrer">
                  <div class="dropdown-item-content">
                    <p class="dropdown-item-title mb-0">CSDN</p>
                  </div></a>
              </li>
              <li><hr class="dropdown-divider"></li>
            </ul>
          </li>
        </ul>
        
    <hr class="d-xxl-none">
    <form class="search-bar ms-auto my-auto" action="/zh-cn/search/" novalidate>
      <div class="input-group align-items-center">
        <span class="btn btn-search disabled position-absolute left-0 border-0 px-1">
          <i class="fas fa-fw fa-search fa-lg"></i>
        </span>
        <input
          class="my-1 form-control border-white rounded-5 search-input bg-body"
          name="q"
          type="search"
          placeholder="搜索"
          aria-label="Search"
          required>
          <span class="search-shortcut position-absolute end-0 top-0 me-2">
            <kbd class="text-dark bg-white opacity-75 rounded-3 shadow border border-primary py-1 fw-bold">/</kbd>
          </span>
      </div>
    </form><hr class="d-xxl-none">
        <ul class="navbar-nav flex-row flex-wrap align-items-center ms-md-auto">
<li class="nav-item py-2 py-xxl-1 col-12 col-xxl-auto">


<nav class="social-links nav justify-content-center flex-row">
      <a class="nav-link social-link col-6 col-xxl-auto p-1" target="_blank" href="https://github.com/kingdix10" title="GitHub" rel="me">
        <i class="fa-fw fab fa-github"
          ></i>
        <span class="ms-1 d-xxl-none">Github</span>
      </a>
      <a class="nav-link social-link col-6 col-xxl-auto p-1" target="_blank" href="https://www.zhihu.com/people/kingdix10" title="知乎" rel="me">
        <i class="fa-fw fab fa-zhihu"
          ></i>
        <span class="ms-1 d-xxl-none">Zhihu</span>
      </a>
  <a class="nav-link social-link col-6 col-xxl-auto p-1" target="_blank" href="/zh-cn/index.xml" title="RSS" rel="me">
    <i class="fas fa-fw fa-rss"></i>
    <span class="ms-1 d-xxl-none">RSS</span>
  </a>
</nav>

</li>
<li class="nav-item py-2 py-xxl-1 col-12 col-xxl-auto">
  <div class="vr d-none d-xxl-flex h-100 mx-xxl-2 text-white"></div>
  <hr class="d-xxl-none my-2">
</li>
<li class="nav-item dropdown py-1 py-xxl-1 col-6 col-xxl-auto">
    <a class="nav-link px-0 px-xxl-1" href="#" id="languageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-fw fa-globe"></i>
        <span class="d-xxl-none">语言</span>
    </a>
    <ul class="language-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
        <li>
        <a class="dropdown-item active" href="/zh-cn/">
            简体中文
        </a>
        </li>
        <li>
        <a class="dropdown-item" href="/en/">
            English
        </a>
        </li></ul>
</li>
<li class="nav-item py-1 col-12 col-xxl-auto">
  <div class="vr d-none d-xxl-flex h-100 mx-xxl-2 text-white"></div>
  <hr class="d-xxl-none my-2">
</li>
<li class="nav-item dropdown col-6 col-xxl-auto">
    <a class="nav-link px-0 py-2 px-xxl-1" href="#" id="fontSizeDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-fw fa-font"></i>
        <span class="d-xxl-none">字体大小</span>
    </a>
    <ul class="font-size-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby="fontSizeDropdown">
        <li>
            <button class="font-size-item dropdown-item" data-size="xs">
                特小号
            </button>
        </li>
        <li>
            <button class="font-size-item dropdown-item" data-size="sm">
                小号
            </button>
        </li>
        <li>
            <button class="font-size-item dropdown-item active" data-size="md">
                中等
            </button>
        </li>
        <li>
            <button class="font-size-item dropdown-item" data-size="lg">
                大号
            </button>
        </li>
        <li>
            <button class="font-size-item dropdown-item" data-size="xl">
                特大号
            </button>
        </li>
    </ul>
</li>
<li class="nav-item dropdown col-6 col-xxl-auto">
    <a class="nav-link px-0 py-2 px-xxl-1" href="#" id="paletteDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-fw fa-palette"></i>
        <span class="d-xxl-none">配色</span>
    </a>
    <ul class="palette-dropdown-menu dropdown-menu dropdown-menu-end px-2 row g-2" aria-labelledby="paletteDropdown">
            <li class="col-4 my-1">
                <a role="button" id="palette-blue" aria-label="蓝色"
                    class="btn btn-sm w-100 palette text-bg-blue" data-palette="blue">
                </a>
            </li>
            <li class="col-4 my-1">
                <a role="button" id="palette-blue-gray" aria-label="蓝灰色"
                    class="btn btn-sm w-100 palette text-bg-blue-gray" data-palette="blue-gray">
                </a>
            </li>
            <li class="col-4 my-1">
                <a role="button" id="palette-brown" aria-label="棕色"
                    class="btn btn-sm w-100 palette text-bg-brown" data-palette="brown">
                </a>
            </li>
            <li class="col-4 my-1">
                <a role="button" id="palette-cyan" aria-label="青色"
                    class="btn btn-sm w-100 palette text-bg-cyan" data-palette="cyan">
                </a>
            </li>
            <li class="col-4 my-1">
                <a role="button" id="palette-green" aria-label="绿色"
                    class="btn btn-sm w-100 palette text-bg-green" data-palette="green">
                </a>
            </li>
            <li class="col-4 my-1">
                <a role="button" id="palette-indigo" aria-label="靛青色"
                    class="btn btn-sm w-100 palette text-bg-indigo" data-palette="indigo">
                </a>
            </li>
            <li class="col-4 my-1">
                <a role="button" id="palette-orange" aria-label="橙色"
                    class="btn btn-sm w-100 palette text-bg-orange" data-palette="orange">
                </a>
            </li>
            <li class="col-4 my-1">
                <a role="button" id="palette-pink" aria-label="粉色"
                    class="btn btn-sm w-100 palette text-bg-pink" data-palette="pink">
                </a>
            </li>
            <li class="col-4 my-1">
                <a role="button" id="palette-purple" aria-label="紫色"
                    class="btn btn-sm w-100 palette text-bg-purple" data-palette="purple">
                </a>
            </li>
            <li class="col-4 my-1">
                <a role="button" id="palette-red" aria-label="红色"
                    class="btn btn-sm w-100 palette text-bg-red" data-palette="red">
                </a>
            </li>
            <li class="col-4 my-1">
                <a role="button" id="palette-teal" aria-label="蓝绿色"
                    class="btn btn-sm w-100 palette text-bg-teal" data-palette="teal">
                </a>
            </li>
            <li class="col-4 my-1">
                <a role="button" id="palette-yellow" aria-label="黄色"
                    class="btn btn-sm w-100 palette text-bg-yellow" data-palette="yellow">
                </a>
            </li>
    </ul>
</li>
<li class="nav-item dropdown col-6 col-xxl-auto">
    <a class="nav-link px-0 py-2 px-xxl-1" href="#" id="modeDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="mode-icon fas fa-fw fa-adjust" id="modeIcon"></i>
        <span class="d-xxl-none">模式</span>
    </a>
    <ul class="mode-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby="modeDropdown">
        <li class="mode-item" data-color-mode="light" data-icon="sun">
            <button class="dropdown-item">
                <i class="mode-icon fas fa-fw fa-sun"></i> 浅色
            </button>
        </li>
        <li class="mode-item" data-color-mode="dark" data-icon="moon">
            <button class="dropdown-item">
                <i class="mode-icon fas fa-fw fa-moon"></i> 深色
            </button>
        </li>
        <li class="mode-item active" data-color-mode="auto" data-icon="adjust">
            <button class="dropdown-item">
                <i class="mode-icon fas fa-fw fa-adjust"></i> 自动
            </button>
        </li>
    </ul>
</li>
        </ul>
      </div>
    </div>
    <div class="d-flex">
      <button class="navbar-toggler order-5 border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#navbarMenus"
        aria-controls="navbarMenus" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-ellipsis-h"></i>
      </button>
    </div>
  </div>
</nav>

</header>

    <main class="container">
      <div class="row content"><noscript>
    <div class="alert alert-danger" role="alert">你的浏览器不支持 JavaScript。</div>
</noscript>
<aside class="docs-nav col-xxl-2" tabindex="-1" data-bs-hide="focusout">
  <div class="offcanvas-xxl offcanvas-start" id="offcanvasDocsNav" aria-labelledby="offcanvasDocsNavLabel">
    <div class="offcanvas-header border-bottom">
      <div class="offcanvas-title h5" id="offcanvasDocsNavLabel">浏览文档</div>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#offcanvasDocsNav"></button>
    </div>
    <div class="offcanvas-body pt-2 flex-column"><div class="mb-3" style="margin-left: -0.5rem;">
</div>
<ul class="list-unstyled mb-2 w-100"><li class="mb-2" tabindex="-1">
          <div class="py-1 d-flex justify-content-between align-items-center ms-3 text-primary">
            <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/"><span class="docs-nav-title">Linux内核分析</span></a>
            <a class="btn-toggle ms-1" role="button" data-bs-toggle="collapse"
              data-bs-target="#nav-8d43cfa49df325f277d6f4234a021467" aria-expanded="true" aria-controls="nav-8d43cfa49df325f277d6f4234a021467">
              <i class="btn-toggle-icon fas fa-chevron-down ms-auto" data-fa-transform="rotate-270"></i>
            </a>
          </div>
          <div class="docs-nav-subnavs border-start mt-2 collapse  show border-primary" id="nav-8d43cfa49df325f277d6f4234a021467">
            <div class="btn-toggle-nav fw-normal ms-2 small">
              <ul class="list-unstyled mb-2 w-100"><li class="mb-2" tabindex="-1">
          <div class="py-1 d-flex justify-content-between align-items-center ms-3">
            <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/"><span class="docs-nav-title">linux-6.1</span></a>
            <a class="btn-toggle ms-1 collapsed" role="button" data-bs-toggle="collapse"
              data-bs-target="#nav-8ea97fb7a0a0d68cedef1b63b4664daa" aria-expanded="false" aria-controls="nav-8ea97fb7a0a0d68cedef1b63b4664daa">
              <i class="btn-toggle-icon fas fa-chevron-down ms-auto" data-fa-transform="rotate-270"></i>
            </a>
          </div>
          <div class="docs-nav-subnavs border-start mt-2 collapse " id="nav-8ea97fb7a0a0d68cedef1b63b4664daa">
            <div class="btn-toggle-nav fw-normal ms-2 small">
              <ul class="list-unstyled mb-2 w-100"><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/sched/01-task_0/"><span class="docs-nav-title">Linux 0号线程swapper简介</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/sched/02-task_1/"><span class="docs-nav-title">Linux 1号线程init简介</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/sched/03-task_2/"><span class="docs-nav-title">Linux 2号线程kthreadd简介</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/thermal/thermal/"><span class="docs-nav-title">linux thermal子系统简介</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/other/linux-err-retur/"><span class="docs-nav-title">Linux的errno简介</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/fdt/dt_to_dt/"><span class="docs-nav-title">Linux内核驱动模型（二）设备树转换</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/device_driver/initcall/"><span class="docs-nav-title">Linux内核驱动模型（三）驱动初始化</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/device_driver/device_model/"><span class="docs-nav-title">Linux内核驱动模型（四）核心结构体</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/fdt/fdt_dt/"><span class="docs-nav-title">Linux内核驱动模型（一）设备树展开</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/time/02-timekeeping/"><span class="docs-nav-title">linux内核时间子系统（二）</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/time/01-tim/"><span class="docs-nav-title">linux内核时间子系统（一）</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/kobject/kobject/"><span class="docs-nav-title">Linux内核数据结构kobject/kset/ktype</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.1/boot/01-entry/"><span class="docs-nav-title">内核启动流程（一）</span></a>
        </li></ul>
            </div>
          </div>
        </li><li class="mb-2" tabindex="-1">
          <div class="py-1 d-flex justify-content-between align-items-center ms-3 text-primary">
            <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/"><span class="docs-nav-title">linux-6.6</span></a>
            <a class="btn-toggle ms-1" role="button" data-bs-toggle="collapse"
              data-bs-target="#nav-c105b2ef486b2fc777c1f47c8c02d8c9" aria-expanded="true" aria-controls="nav-c105b2ef486b2fc777c1f47c8c02d8c9">
              <i class="btn-toggle-icon fas fa-chevron-down ms-auto" data-fa-transform="rotate-270"></i>
            </a>
          </div>
          <div class="docs-nav-subnavs border-start mt-2 collapse  show border-primary" id="nav-c105b2ef486b2fc777c1f47c8c02d8c9">
            <div class="btn-toggle-nav fw-normal ms-2 small">
              <ul class="list-unstyled mb-2 w-100"><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/syscall/syscall/"><span class="docs-nav-title">【Linux内核|系统调用】深度分析系统调用从用户程序到内核的流程</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/kdump_crash/arm64_setup/"><span class="docs-nav-title">ARM64 Crash调试环境搭建</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/misc/jump_label/"><span class="docs-nav-title">ARM64 jump label源码分析</span></a>
        </li><li class="mb-2 py-1 ms-3 text-primary" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/interrupt/cpu_interrupt_entry/"><span class="docs-nav-title">ARM64 Linux中断入口</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/kdump_crash/help/"><span class="docs-nav-title">Crash帮助信息</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/mm/arm64_pgtabl/"><span class="docs-nav-title">Linux ARM64页面大小和虚拟地址位数</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/drm/drm_/"><span class="docs-nav-title">Linux drm mm分析</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/sched/06-a-fork/"><span class="docs-nav-title">Linux fork进程/线程简介</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/sched/04-relationship/"><span class="docs-nav-title">Linux进程和线程关系</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/sched/05-pid_namespa/"><span class="docs-nav-title">Linux进程命名空间（pid namespace）</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/sched/07-task_stat/"><span class="docs-nav-title">Linux进程状态与生命周期</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/sched/06-b-copy_process_2/"><span class="docs-nav-title">Linux内核copy_process分析（二）</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/sched/06-b-copy_process_3/"><span class="docs-nav-title">Linux内核copy_process分析（三）</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/sched/06-b-copy_process_1/"><span class="docs-nav-title">Linux内核copy_process分析（一）</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/sched/sched_class_tabl/"><span class="docs-nav-title">Linux内核sched_class汇总</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/optimize_tips/"><span class="docs-nav-title">Linux内核代码的编写和优化技巧</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/boot/01-entry/"><span class="docs-nav-title">内核启动流程（一）</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/interrupt/03-irq_create_mapping/"><span class="docs-nav-title">设备中断注册</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/interrupt/04-request_irq/"><span class="docs-nav-title">申请中断request_irq</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/interrupt/05-handler_entry/"><span class="docs-nav-title">中断处理</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/interrupt/02-irq_domain_a/"><span class="docs-nav-title">中断子系统domain注册</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/04-kernel/linux-6.6/interrupt/01-init/"><span class="docs-nav-title">中断子系统软硬件初始化</span></a>
        </li></ul>
            </div>
          </div>
        </li></ul>
            </div>
          </div>
        </li><li class="mb-2" tabindex="-1">
          <div class="py-1 d-flex justify-content-between align-items-center ms-3">
            <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/02-dev_env/"><span class="docs-nav-title">开发环境</span></a>
            <a class="btn-toggle ms-1 collapsed" role="button" data-bs-toggle="collapse"
              data-bs-target="#nav-fd57bc387b9c3a4d19f1801fc65cd5b4" aria-expanded="false" aria-controls="nav-fd57bc387b9c3a4d19f1801fc65cd5b4">
              <i class="btn-toggle-icon fas fa-chevron-down ms-auto" data-fa-transform="rotate-270"></i>
            </a>
          </div>
          <div class="docs-nav-subnavs border-start mt-2 collapse " id="nav-fd57bc387b9c3a4d19f1801fc65cd5b4">
            <div class="btn-toggle-nav fw-normal ms-2 small">
              <ul class="list-unstyled mb-2 w-100"><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/02-dev_env/eel_env/eel_readm/"><span class="docs-nav-title">嵌入式学习环境快速搭建（二）</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/02-dev_env/eel_env/env_setup/"><span class="docs-nav-title">嵌入式学习环境快速搭建（一）</span></a>
        </li></ul>
            </div>
          </div>
        </li><li class="mb-2" tabindex="-1">
          <div class="py-1 d-flex justify-content-between align-items-center ms-3">
            <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/03-boot/"><span class="docs-nav-title">启动</span></a>
            <a class="btn-toggle ms-1 collapsed" role="button" data-bs-toggle="collapse"
              data-bs-target="#nav-05b799579ad52d4ccfa92fd6313b23f7" aria-expanded="false" aria-controls="nav-05b799579ad52d4ccfa92fd6313b23f7">
              <i class="btn-toggle-icon fas fa-chevron-down ms-auto" data-fa-transform="rotate-270"></i>
            </a>
          </div>
          <div class="docs-nav-subnavs border-start mt-2 collapse " id="nav-05b799579ad52d4ccfa92fd6313b23f7">
            <div class="btn-toggle-nav fw-normal ms-2 small">
              <ul class="list-unstyled mb-2 w-100"><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/03-boot/u-boot/uboot_m/"><span class="docs-nav-title">U-Boot从dtb获取内存布局并传递到内核</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/03-boot/u-boot/crc32_fu/"><span class="docs-nav-title">U-Boot和Linux内核的CRC函数</span></a>
        </li></ul>
            </div>
          </div>
        </li><li class="mb-2" tabindex="-1">
          <div class="py-1 d-flex justify-content-between align-items-center ms-3">
            <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/01-os/"><span class="docs-nav-title">系统工具</span></a>
            <a class="btn-toggle ms-1 collapsed" role="button" data-bs-toggle="collapse"
              data-bs-target="#nav-eb1c5d775f73e30b3a27244e12a84f81" aria-expanded="false" aria-controls="nav-eb1c5d775f73e30b3a27244e12a84f81">
              <i class="btn-toggle-icon fas fa-chevron-down ms-auto" data-fa-transform="rotate-270"></i>
            </a>
          </div>
          <div class="docs-nav-subnavs border-start mt-2 collapse " id="nav-eb1c5d775f73e30b3a27244e12a84f81">
            <div class="btn-toggle-nav fw-normal ms-2 small">
              <ul class="list-unstyled mb-2 w-100"><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/01-os/linux/git/git_mis/"><span class="docs-nav-title">git配置和操作</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/01-os/linux/shell/bash_tips/"><span class="docs-nav-title">Linux Bash技巧</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/01-os/linux/shell/bash_decorat/"><span class="docs-nav-title">Linux Bash终端美化</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/01-os/linux/resizefs/"><span class="docs-nav-title">磁盘和文件系统扩容/缩容</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/01-os/win/win_python3/"><span class="docs-nav-title">解决Windows不能使用python3.10的问题</span></a>
        </li></ul>
            </div>
          </div>
        </li><li class="mb-2" tabindex="-1">
          <div class="py-1 d-flex justify-content-between align-items-center ms-3">
            <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/99-jottings/"><span class="docs-nav-title">杂项</span></a>
            <a class="btn-toggle ms-1 collapsed" role="button" data-bs-toggle="collapse"
              data-bs-target="#nav-4967b62f3b1964eee9739b39b25cd3eb" aria-expanded="false" aria-controls="nav-4967b62f3b1964eee9739b39b25cd3eb">
              <i class="btn-toggle-icon fas fa-chevron-down ms-auto" data-fa-transform="rotate-270"></i>
            </a>
          </div>
          <div class="docs-nav-subnavs border-start mt-2 collapse " id="nav-4967b62f3b1964eee9739b39b25cd3eb">
            <div class="btn-toggle-nav fw-normal ms-2 small">
              <ul class="list-unstyled mb-2 w-100"><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/99-jottings/01-c/array_fu/"><span class="docs-nav-title">多维数组作为函数参数</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/99-jottings/01-c/array_typ/"><span class="docs-nav-title">数组a、&amp;a、&amp;a[0]、&amp;a[0][0]的区别与联系</span></a>
        </li></ul>
            </div>
          </div>
        </li><li class="mb-2" tabindex="-1">
          <div class="py-1 d-flex justify-content-between align-items-center ms-3">
            <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/exynos4412/"><span class="docs-nav-title">4412</span></a>
            <a class="btn-toggle ms-1 collapsed" role="button" data-bs-toggle="collapse"
              data-bs-target="#nav-0cca8bc16c798175efb847597812f8c0" aria-expanded="false" aria-controls="nav-0cca8bc16c798175efb847597812f8c0">
              <i class="btn-toggle-icon fas fa-chevron-down ms-auto" data-fa-transform="rotate-270"></i>
            </a>
          </div>
          <div class="docs-nav-subnavs border-start mt-2 collapse " id="nav-0cca8bc16c798175efb847597812f8c0">
            <div class="btn-toggle-nav fw-normal ms-2 small">
              <ul class="list-unstyled mb-2 w-100"><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/exynos4412/exynos4412/"><span class="docs-nav-title">Exynos4412启动介绍</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/exynos4412/mkbl1/"><span class="docs-nav-title">Exynos4412自制BL1</span></a>
        </li><li class="mb-2 py-1 ms-3" tabindex="-1">
          <a class="docs-nav-link d-flex align-items-center" href="/zh-cn/docs/exynos4412/mkbl2/"><span class="docs-nav-title">Exynos4412自制BL2</span></a>
        </li></ul>
            </div>
          </div>
        </li></ul></div>
  </div>
</aside><div class="col-xxl-7 ms-auto">
  <div class="container-fluid"><nav class="row card component" aria-label="breadcrumb">
  <div class="card-body pb-0">
    <ol class="hbs-breadcrumb breadcrumb flex-nowrap"><li class="breadcrumb-item text-surface"><a href="/zh-cn/">主页</a></li><li class="breadcrumb-item text-surface"><a href="/zh-cn/docs/">文档</a></li><li class="breadcrumb-item text-surface"><a href="/zh-cn/docs/04-kernel/">Linux内核分析</a></li><li class="breadcrumb-item text-surface"><a href="/zh-cn/docs/04-kernel/linux-6.6/">linux-6.6</a></li><li class="breadcrumb-item active">ARM64 Linux中断入口</li></ol>
  </div>
</nav><div class="post-panel-wrapper position-relative d-flex justify-content-center">
  <div class="d-flex flex-row justify-content-center rounded-5 border post-panel position-fixed px-3 py-1 surface shadow-1">
    
    

    
    
    
<a class="action action-toc d-block d-xxl-none" href="#post-toc-container" role="button" title="目录">
  <i class="fas fa-fw fa-list-alt"></i>
</a>
    <a class="action action-copyright" href="#post-copyright" role="button" aria-label="Copyright" title="版权">
  <i class="fas fa-fw fa-copyright"></i>
</a>
    
    
<a id="sidebarToggler" class="action action-sidebar-toggler d-none d-xxl-block" role="button" title="切换侧边栏">
  <i class="fas fa-fw fa-expand-alt" data-fa-transform="rotate-45"></i>
</a>

    
  </div>
</div><article class="row card component mb-4 post">
<div class="card-header ">
    <h1 class="card-title post-title my-2">ARM64 Linux中断入口</h1>
</div>
<div class="card-body"><div class="post-meta mb-3">
  <span class="post-date me-1 mb-1" title="创建于 2024-04-20 08:00:00 &#43;0800 CST。">2024/04/20</span><span class="post-reading-time me-1 mb-1">17 分钟阅读</span><a href="/zh-cn/categories/%E4%B8%AD%E6%96%AD%E7%AE%A1%E7%90%86/" class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-category">
      <i class="fas fa-fw fa-folder me-1"></i>中断管理</a><a href="/zh-cn/tags/linux-6.6/" class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-tag">Linux-6.6</a><a href="/zh-cn/tags/linux%E5%86%85%E6%A0%B8/" class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-tag">Linux内核</a>
</div>
<picture class="d-flex justify-content-center"><img class="post-featured-img h-auto w-auto mb-3" alt="ARM64 Linux中断入口" src="https://kingdix10.github.io/covers/lens_camera_glare_147903_300x168.jpg"/>
    </picture>
<div class="mt-2 mb-3 d-block d-xxl-none">
    <h2 class="text-surface mb-3">目录</h2>
    <div id="post-toc-container">
        </div>
    <hr class="text-secondary">
</div><div class="post-content mb-3" data-bs-spy="scroll" data-bs-target="#TableOfContents" tabindex="0">
        <div id="post-content-body">
<h1 id="1-简介" data-numberify>1. 简介<a class="anchor ms-1" href="#1-简介"></a></h1>
<p>ARM64中断入口相关的代码主要在<code>arch/arm64/kernel/entry.S</code>，启动过程中，会将中断向量表<code>vectors</code>的起始虚拟地址写入到VBAR_EL1。</p>
<p>当发生中断或者异常时，硬件会保存一些寄存器，然后就是软件的工作：</p>
<ol>
<li>进入中断后，根据中断原因，跳转到对应的中断处理函数，这部分是汇编实现。</li>
<li>在中断处理函数中，先通过<code>kernel_entry</code>将寄存器压栈，然后将栈空间记录的<code>struct pt_regs</code>传递给C语言的对应中断处理函数。</li>
<li>完成中断处理后，根据中断发生的异常等级，决定是调用<code>ret_to_user</code>还是<code>ret_to_kernel</code>退出中断，这两个hasn&rsquo;t都是对汇编代码<code>kernel_exit</code>的封装。</li>
</ol>

<h2 id="11-中断向量基地址寄存器配置" data-numberify>1.1. 中断向量基地址寄存器配置<a class="anchor ms-1" href="#11-中断向量基地址寄存器配置"></a></h2>
<p>在kernel启动的一开始，会将中断向量表的起始虚拟地址写入到VBAR_EL1。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">/// arch/arm64/kernel/head.S
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1"></span>    <span class="n">adr_l</span>	<span class="n">x8</span><span class="p">,</span> <span class="n">vectors</span>			<span class="c1">// load VBAR_EL1 with virtual
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"></span>    <span class="n">msr</span>	<span class="n">vbar_el1</span><span class="p">,</span> <span class="n">x8</span>			<span class="c1">// vector table address
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"></span>    <span class="n">isb</span>
</span></span></code></pre></div>
<h1 id="2-中断向量表" data-numberify>2. 中断向量表<a class="anchor ms-1" href="#2-中断向量表"></a></h1>
<p>根据<a href="https://developer.arm.com/documentation/den0024/latest" target="_blank" rel="noopener noreferrer">DEN0024A_v8_architecture_PG<i class="fas fa-external-link-square-alt ms-1"></i></a>描述，后缀t和h表示使用不同的sp指针。意思是捕获异常时所在的异常等级使用的sp寄存器。</p>
<p><picture><img class="img-fluid " alt="" src="/zh-cn/docs/04-kernel/linux-6.6/interrupt/cpu_interrupt_entry/image.png" loading="lazy" width="1625" height="1542" />
</picture>

</p>
<p><a href="https://developer.arm.com/documentation/ddi0487/latest/" target="_blank" rel="noopener noreferrer">Arm Architecture Reference Manual for A-profile architecture<i class="fas fa-external-link-square-alt ms-1"></i></a></p>
<p><picture><img class="img-fluid " alt="" src="/zh-cn/docs/04-kernel/linux-6.6/interrupt/cpu_interrupt_entry/image-1.png" loading="lazy" width="1695" height="1188" />
</picture>

</p>
<p><picture><img class="img-fluid " alt="" src="/zh-cn/docs/04-kernel/linux-6.6/interrupt/cpu_interrupt_entry/image-2.png" loading="lazy" width="1654" height="1064" />
</picture>

</p>
<p>中断向量一共有四组表，每组有四个异常入口，分别对应同步异常、IRQ、FIQ、SError。</p>
<table>
<thead>
<tr>
<th style="text-align:center">入口</th>
<th style="text-align:center">异常等级切换</th>
<th style="text-align:center">运行状态</th>
<th style="text-align:left">异常前使用的sp</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">N</td>
<td style="text-align:center">AArch64</td>
<td style="text-align:left">SP_EL0</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">N</td>
<td style="text-align:center">AArch64</td>
<td style="text-align:left">SP_EL1/2/3</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">Y</td>
<td style="text-align:center">AArch64</td>
<td style="text-align:left">SP_EL0</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">Y</td>
<td style="text-align:center">AArch32</td>
<td style="text-align:left">SP_EL0</td>
</tr>
</tbody>
</table>
<p>对于第一组入口，Linux在内核态下不可能使用SP_EL0作为栈指针，所以内核将其handler设置为<code>UNHANDLED</code>。</p>

<h1 id="3-linux内核的中断入口" data-numberify>3. Linux内核的中断入口<a class="anchor ms-1" href="#3-linux内核的中断入口"></a></h1>
<p>内核的<code>vectors</code>定义如下，通过捕获异常的等级、使用的sp寄存器、异常类型、处理器指令集(AArch32/AArch64)，可以唯一确定要跳转的中断入口。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">/// arch/arm64/kernel/entry.S
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="cm"> * Exception vectors.
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="p">.</span><span class="n">pushsection</span> <span class="s">&#34;.entry.text&#34;</span><span class="p">,</span> <span class="s">&#34;ax&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="p">.</span><span class="n">align</span>	<span class="mi">11</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="nf">SYM_CODE_START</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="c1">/// UNHANDLED
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">sync</span>		<span class="c1">// Synchronous EL1t
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">irq</span>		<span class="c1">// IRQ EL1t
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fiq</span>		<span class="c1">// FIQ EL1t
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">error</span>		<span class="c1">// Error EL1t
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="c1">/// 中断或异常发送在EL1
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">sync</span>		<span class="c1">// Synchronous EL1h
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">irq</span>		<span class="c1">// IRQ EL1h
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fiq</span>		<span class="c1">// FIQ EL1h
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">error</span>		<span class="c1">// Error EL1h
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="c1">/// 中断或异常发送在EL0
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">sync</span>		<span class="c1">// Synchronous 64-bit EL0
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">irq</span>		<span class="c1">// IRQ 64-bit EL0
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fiq</span>		<span class="c1">// FIQ 64-bit EL0
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">error</span>		<span class="c1">// Error 64-bit EL0
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="c1">/// UNHANDLED或中断或异常发送在EL0(AArch32)
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">sync</span>		<span class="c1">// Synchronous 32-bit EL0
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">irq</span>		<span class="c1">// IRQ 32-bit EL0
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_ventry</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">fiq</span>
</span></span></code></pre></div><p>根据<a href="https://developer.arm.com/documentation/den0024/latest" target="_blank" rel="noopener noreferrer">DEN0024A_v8_architecture_PG<i class="fas fa-external-link-square-alt ms-1"></i></a>描述，不同的异常等级，使用的寄存器有所不同。</p>
<p><picture><img class="img-fluid " alt="" src="/zh-cn/docs/04-kernel/linux-6.6/interrupt/cpu_interrupt_entry/image-3.png" loading="lazy" width="1754" height="581" />
</picture>

</p>

<h2 id="31-硬件的工作" data-numberify>3.1. 硬件的工作<a class="anchor ms-1" href="#31-硬件的工作"></a></h2>
<p>进入和退出中断时，硬件完成的工作。</p>
<p>进入时主要工作如下：</p>
<ol>
<li>将处理器状态PSTATE寄存器保存到SPSR_ELx中，其中是捕获异常级别。</li>
<li>将异常返回地址保存到ELR_ELx，其中是捕获异常级别。</li>
<li>设置PSTATE的DAIF为1，关闭调试异常、SError、IRQ和FIQ。</li>
<li>如果是同步异常或SError，将异常信息写入ESR_ELx。</li>
<li>如果是地址访问相关的异常，将导致异常的虚拟地址写入FAR_ELx。</li>
<li>切换到指定异常等级的sp。</li>
<li>将处理器设置到对应的异常等级，然后跳转到异常向量表执行。</li>
</ol>
<p>软件调用eret退出时：
使用ELR_ELx和SPSR_ELx恢复处理器状态，然后返回到异常发生的位置。</p>
<p><a href="https://developer.arm.com/documentation/" target="_blank" rel="noopener noreferrer">Learn the architecture - AArch64 Exception Model<i class="fas fa-external-link-square-alt ms-1"></i></a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">When an exception is taken, the current state must be preserved so that it can be returned to. The
</span></span><span class="line"><span class="ln">2</span><span class="cl">PE will automatically preserve the exception return address and the current PSTATE.
</span></span><span class="line"><span class="ln">3</span><span class="cl">The state stored in the general-purpose registers must be preserved by software. The PE will then
</span></span><span class="line"><span class="ln">4</span><span class="cl">update the current PSTATE to the one defined in the architecture for that exception type, and
</span></span><span class="line"><span class="ln">5</span><span class="cl">branch to the exception handler in the vector table.
</span></span><span class="line"><span class="ln">6</span><span class="cl">The PSTATE the exception was taken from is stored in the System register SPSR_ELx, where &lt;x&gt; is
</span></span><span class="line"><span class="ln">7</span><span class="cl">the number of the Exception level that the exception was taken to. The exception return address is
</span></span><span class="line"><span class="ln">8</span><span class="cl">stored in ELR_ELx, where &lt;x&gt; is the Exception level that the exception was taken to.
</span></span></code></pre></div><p><a href="https://developer.arm.com/documentation/ddi0487/latest/" target="_blank" rel="noopener noreferrer">Arm Architecture Reference Manual for A-profile architecture<i class="fas fa-external-link-square-alt ms-1"></i></a></p>
<p><picture><img class="img-fluid " alt="" src="/zh-cn/docs/04-kernel/linux-6.6/interrupt/cpu_interrupt_entry/image-4.png" loading="lazy" width="1662" height="1640" />
</picture>

</p>

<h1 id="4-中断入口定义kernel_ventry" data-numberify>4. 中断入口定义：kernel_ventry<a class="anchor ms-1" href="#4-中断入口定义kernel_ventry"></a></h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">/// arch/arm64/kernel/entry.S
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="n">macro</span> <span class="n">kernel_ventry</span><span class="p">,</span> <span class="nl">el</span><span class="p">:</span><span class="n">req</span><span class="p">,</span> <span class="nl">ht</span><span class="p">:</span><span class="n">req</span><span class="p">,</span> <span class="nl">regsize</span><span class="p">:</span><span class="n">req</span><span class="p">,</span> <span class="nl">label</span><span class="p">:</span><span class="n">req</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>                    <span class="c1">/// 128(2^7)字节对齐
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">Lventry_start</span><span class="err">\@</span><span class="o">:</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="p">.</span><span class="k">if</span>	<span class="err">\</span><span class="n">el</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="cm">     * This must be the first instruction of the EL0 vector entries. It is
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="cm">     * skipped by the trampoline vectors, to trigger the cleanup.
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="n">b</span>	<span class="p">.</span><span class="n">Lskip_tramp_vectors_cleanup</span><span class="err">\@</span>  <span class="c1">/// 是跳过清理跳板中断向量表
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span>    <span class="c1">/// 还不清楚跳板中断向量表如何起作用，但是如下指令实际不会走到
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="k">if</span>	<span class="err">\</span><span class="n">regsize</span> <span class="o">==</span> <span class="mi">64</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="c1">/// Thread ID registers，TPIDRRO_EL0包含当前处理器的 CPU 编号
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="c1"></span>    <span class="n">mrs</span>	<span class="n">x30</span><span class="p">,</span> <span class="n">tpidrro_el0</span>                <span class="c1">/// 备份tpidrro_el0到x30
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1"></span>    <span class="n">msr</span>	<span class="n">tpidrro_el0</span><span class="p">,</span> <span class="n">xzr</span>                <span class="c1">/// 清零tpidrro_el0
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="k">else</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="n">mov</span>	<span class="n">x30</span><span class="p">,</span> <span class="n">xzr</span>                        <span class="c1">/// 清零x30(w30)，对应AArch32 fiq下的r14(lr)
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="n">endif</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="p">.</span><span class="n">Lskip_tramp_vectors_cleanup</span><span class="err">\@</span><span class="o">:</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="p">.</span><span class="n">endif</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="n">sub</span>	<span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">PT_REGS_SIZE</span>           <span class="c1">/// 在栈中为struct pt_regs留出空间
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="c1"></span><span class="cp">#ifdef CONFIG_VMAP_STACK
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="cp"></span>    <span class="c1">/// 一些栈溢出相关操作和sp的设置，不影响中断处理流程分析
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="cp"></span>    <span class="n">b</span>	<span class="n">el</span><span class="err">\</span><span class="n">el</span><span class="err">\</span><span class="n">ht</span><span class="err">\</span><span class="p">()</span><span class="n">_</span><span class="err">\</span><span class="n">regsize</span><span class="err">\</span><span class="p">()</span><span class="n">_</span><span class="err">\</span><span class="n">label</span>  <span class="c1">/// 跳转到真正的处理函数
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">org</span> <span class="p">.</span><span class="n">Lventry_start</span><span class="err">\@</span> <span class="o">+</span> <span class="mi">128</span>	<span class="c1">// Did we overflow the ventry slot?
</span></span></span></code></pre></div><p><code>kernel_ventry</code>是一个汇编宏，其主要作用如下：</p>
<ol>
<li>在栈中为<code>struct pt_regs</code>留出空间</li>
<li>跳转到真正的处理函数，比如代码中<code>b	el\el\ht\()_\regsize\()_\label</code></li>
</ol>
<p>以<code>kernel_ventry	1, t, 64, sync		// Synchronous EL1t</code>为例来看一下效果，最后会调用<code>el1t_64_sync</code></p>

<h2 id="41-entry_handler" data-numberify>4.1. entry_handler<a class="anchor ms-1" href="#41-entry_handler"></a></h2>
<p>中断处理函数使用汇编宏<code>entry_handler</code>进行定义，其代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">/// arch/arm64/kernel/entry.S
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="n">macro</span> <span class="n">entry_handler</span> <span class="nl">el</span><span class="p">:</span><span class="n">req</span><span class="p">,</span> <span class="nl">ht</span><span class="p">:</span><span class="n">req</span><span class="p">,</span> <span class="nl">regsize</span><span class="p">:</span><span class="n">req</span><span class="p">,</span> <span class="nl">label</span><span class="p">:</span><span class="n">req</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="c1">/// 定义符号
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"></span><span class="nf">SYM_CODE_START_LOCAL</span><span class="p">(</span><span class="n">el</span><span class="err">\</span><span class="n">el</span><span class="err">\</span><span class="n">ht</span><span class="err">\</span><span class="p">()</span><span class="n">_</span><span class="err">\</span><span class="n">regsize</span><span class="err">\</span><span class="p">()</span><span class="n">_</span><span class="err">\</span><span class="n">label</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="c1">/// 上下文保存
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"></span>    <span class="n">kernel_entry</span> <span class="err">\</span><span class="n">el</span><span class="p">,</span> <span class="err">\</span><span class="n">regsize</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="c1">/// 此时sp指向struct pt_regs基地址，将其作为参数传给C语言handler
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="c1"></span>    <span class="n">mov</span>	<span class="n">x0</span><span class="p">,</span> <span class="n">sp</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="c1">/// 调用C语言handler
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"></span>    <span class="n">bl</span>	<span class="n">el</span><span class="err">\</span><span class="n">el</span><span class="err">\</span><span class="n">ht</span><span class="err">\</span><span class="p">()</span><span class="n">_</span><span class="err">\</span><span class="n">regsize</span><span class="err">\</span><span class="p">()</span><span class="n">_</span><span class="err">\</span><span class="n">label</span><span class="err">\</span><span class="p">()</span><span class="n">_handler</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="p">.</span><span class="k">if</span> <span class="err">\</span><span class="n">el</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="n">b</span>	<span class="n">ret_to_user</span>         <span class="c1">/// 退出中断，返回用户模式
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="k">else</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="n">b</span>	<span class="n">ret_to_kernel</span>       <span class="c1">/// 退出中断，返回kernel模式
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="n">endif</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="nf">SYM_CODE_END</span><span class="p">(</span><span class="n">el</span><span class="err">\</span><span class="n">el</span><span class="err">\</span><span class="n">ht</span><span class="err">\</span><span class="p">()</span><span class="n">_</span><span class="err">\</span><span class="n">regsize</span><span class="err">\</span><span class="p">()</span><span class="n">_</span><span class="err">\</span><span class="n">label</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="p">.</span><span class="n">endm</span>
</span></span></code></pre></div><p><code>entry_handler</code>宏的主要工作如下：</p>
<ol>
<li>调用<code>kernel_entry</code>，其主要工作是上下文保存</li>
<li>调用C语言的handler</li>
<li>handler返回后，如果是在EL0发生的中断，调用<code>ret_to_user</code>，否则调用<code>ret_to_kernel</code>。软件处理完成。</li>
</ol>
<p>以<code>entry_handler	1, t, 64, sync</code>为例，这一行声明了<code>el1t_64_sync</code>符号，其内部会调用<code>el1t_64_sync_handler</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">/// arch/arm64/kernel/entry.S
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="cm"> * Early exception handlers
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">sync</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1">/// SYM_CODE_START_LOCAL(el1t_64_sync)
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1">///     ... ...
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="c1">///     bl el1t_64_sync_handler
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1">///     ... ...
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1">/// SYM_CODE_END(el1t_64_sync)
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span>    <span class="n">entry_handler</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">irq</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fiq</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">error</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">sync</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">irq</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fiq</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">error</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">sync</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">irq</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fiq</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">error</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">sync</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">irq</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">fiq</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="n">entry_handler</span>	<span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">error</span>
</span></span></code></pre></div>
<h2 id="42-调用c函数前的准备kernel_entry" data-numberify>4.2. 调用C函数前的准备kernel_entry<a class="anchor ms-1" href="#42-调用c函数前的准备kernel_entry"></a></h2>
<p>前边提到，栈顶要存储的是<code>struct pt_regs</code>，这里先看一下其定义。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">/// arch/arm64/include/asm/ptrace.h
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="cm"> * User structures for general purpose, floating point and debug registers.
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="k">struct</span> <span class="n">user_pt_regs</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="n">__u64</span>		<span class="n">regs</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="n">__u64</span>		<span class="n">sp</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="n">__u64</span>		<span class="n">pc</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="n">__u64</span>		<span class="n">pstate</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="cm"> * This struct defines the way the registers are stored on the stack during an
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="cm"> * exception. Note that sizeof(struct pt_regs) has to be a multiple of 16 (for
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="cm"> * stack alignment). struct user_pt_regs must form a prefix of struct pt_regs.
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="k">struct</span> <span class="n">pt_regs</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="k">struct</span> <span class="n">user_pt_regs</span> <span class="n">user_regs</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">            <span class="n">u64</span> <span class="n">regs</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">            <span class="n">u64</span> <span class="n">sp</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">            <span class="n">u64</span> <span class="n">pc</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">            <span class="n">u64</span> <span class="n">pstate</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="n">u64</span> <span class="n">orig_x0</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="cp">#ifdef __AARCH64EB__
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="cp"></span>    <span class="n">u32</span> <span class="n">unused2</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="n">s32</span> <span class="n">syscallno</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="cp"></span>    <span class="n">s32</span> <span class="n">syscallno</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">    <span class="n">u32</span> <span class="n">unused2</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="cp"></span>    <span class="n">u64</span> <span class="n">sdei_ttbr1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">    <span class="cm">/* Only valid when ARM64_HAS_GIC_PRIO_MASKING is enabled. */</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">    <span class="n">u64</span> <span class="n">pmr_save</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">    <span class="n">u64</span> <span class="n">stackframe</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">
</span></span><span class="line"><span class="ln">40</span><span class="cl">    <span class="cm">/* Only valid for some EL1 exceptions. */</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">    <span class="n">u64</span> <span class="n">lockdep_hardirqs</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">    <span class="n">u64</span> <span class="n">exit_rcu</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>继续向下分析之前，先记住<code>tsk</code>，这个代表<code>x28</code>寄存器，用了记录当前进程的<code>struct thread_info</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">/// arch/arm64/kernel/entry.S
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1"></span><span class="cm">/* GPRs used by entry code */</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="n">tsk</span>	<span class="p">.</span><span class="n">req</span>	<span class="n">x28</span>		<span class="c1">// current thread_info
</span></span></span></code></pre></div>
<h3 id="421-寄存器压栈" data-numberify>4.2.1. 寄存器压栈<a class="anchor ms-1" href="#421-寄存器压栈"></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">/// arch/arm64/kernel/entry.S
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="n">macro</span>	<span class="n">kernel_entry</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">regsize</span> <span class="o">=</span> <span class="mi">64</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="p">.</span><span class="k">if</span>	<span class="err">\</span><span class="n">el</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="c1">/// 用户模式中断，根据需要，修改PSTATE寄存器
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"></span>    <span class="n">alternative_insn</span> <span class="n">nop</span><span class="p">,</span> <span class="nf">SET_PSTATE_DIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ARM64_HAS_DIT</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="p">.</span><span class="n">endif</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="p">.</span><span class="k">if</span>	<span class="err">\</span><span class="n">regsize</span> <span class="o">==</span> <span class="mi">32</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="n">mov</span>	<span class="n">w0</span><span class="p">,</span> <span class="n">w0</span>				<span class="c1">// zero upper 32 bits of x0
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="n">endif</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="c1">/// 下边这些是将寄存器x0~x29压栈，后续可以使用struct pt_regs指针访问
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span>    <span class="n">stp</span>	<span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="n">stp</span>	<span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="n">stp</span>	<span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="n">stp</span>	<span class="n">x6</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="n">stp</span>	<span class="n">x8</span><span class="p">,</span> <span class="n">x9</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="n">stp</span>	<span class="n">x10</span><span class="p">,</span> <span class="n">x11</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="n">stp</span>	<span class="n">x12</span><span class="p">,</span> <span class="n">x13</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="n">stp</span>	<span class="n">x14</span><span class="p">,</span> <span class="n">x15</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">7</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="n">stp</span>	<span class="n">x16</span><span class="p">,</span> <span class="n">x17</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="n">stp</span>	<span class="n">x18</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">9</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="n">stp</span>	<span class="n">x20</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="n">stp</span>	<span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">11</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="n">stp</span>	<span class="n">x24</span><span class="p">,</span> <span class="n">x25</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">12</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="n">stp</span>	<span class="n">x26</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">13</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">    <span class="n">stp</span>	<span class="n">x28</span><span class="p">,</span> <span class="n">x29</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">14</span><span class="p">]</span>
</span></span></code></pre></div>
<h3 id="422-el0和el1的处理" data-numberify>4.2.2. el0和el1的处理<a class="anchor ms-1" href="#422-el0和el1的处理"></a></h3>

<h4 id="4221-el0" data-numberify>4.2.2.1. EL0<a class="anchor ms-1" href="#4221-el0"></a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl">    <span class="p">.</span><span class="k">if</span>	<span class="err">\</span><span class="n">el</span> <span class="o">==</span> <span class="mi">0</span>        <span class="c1">/// 用户模式中断或异常
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span>    <span class="n">clear_gp_regs</span>       <span class="c1">/// 清零x0~x29
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"></span>    <span class="n">mrs</span>	<span class="n">x21</span><span class="p">,</span> <span class="n">sp_el0</span>     <span class="c1">/// x21记录用户模式sp_el0，后续会保存到pt_regs.sp
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"></span>    <span class="c1">/// __entry_task是一个percpu变量，记录当前cpu的task_struct
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"></span>    <span class="c1">/// x20作为临时变量
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"></span>    <span class="c1">/// ldr_this_cpu是将当前cpu的当前task_struct读到tsk(x28)
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"></span>    <span class="n">ldr_this_cpu</span>	<span class="n">tsk</span><span class="p">,</span> <span class="n">__entry_task</span><span class="p">,</span> <span class="n">x20</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="n">msr</span>	<span class="n">sp_el0</span><span class="p">,</span> <span class="n">tsk</span>     <span class="c1">/// sp_el0记录当前进程
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"></span>    <span class="cm">/*
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="cm">     * Ensure MDSCR_EL1.SS is clear, since we can unmask debug exceptions
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="cm">     * when scheduling.
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="n">ldr</span>	<span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">tsk</span><span class="p">,</span> <span class="err">#</span><span class="n">TSK_TI_FLAGS</span><span class="p">]</span>       <span class="c1">/// 加载thread_info.flags到x19
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="c1"></span>    <span class="c1">/// 如果进程允许单步调试，关闭MDSCR_EL1的软件单步控制
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1"></span>    <span class="n">disable_step_tsk</span> <span class="n">x19</span><span class="p">,</span> <span class="n">x20</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="cm">/* Check for asynchronous tag check faults in user space */</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="n">ldr</span>	<span class="n">x0</span><span class="p">,</span> <span class="p">[</span><span class="n">tsk</span><span class="p">,</span> <span class="n">THREAD_SCTLR_USER</span><span class="p">]</span>    <span class="c1">/// 加载thread.sctlr_user到x0
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="c1"></span>    <span class="n">check_mte_async_tcf</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="n">x0</span>    <span class="c1">/// Check for MTE asynchronous tag check faults
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="cp">#ifdef CONFIG_ARM64_PTR_AUTH
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="cp"></span>    <span class="c1">/// ... ...
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">    <span class="n">apply_ssbd</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="n">mte_set_kernel_gcr</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="cm">     * Any non-self-synchronizing system register updates required for
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="cm">     * kernel entry should be placed before this point.
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="n">alternative_if</span> <span class="n">ARM64_MTE</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">    <span class="n">isb</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">    <span class="n">b</span>	<span class="mf">1f</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="n">alternative_else_nop_endif</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="n">alternative_if</span> <span class="n">ARM64_HAS_ADDRESS_AUTH</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">    <span class="n">isb</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="n">alternative_else_nop_endif</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">
</span></span><span class="line"><span class="ln">42</span><span class="cl">    <span class="n">scs_load_current</span>
</span></span></code></pre></div><p><code>__entry_task</code>是一个percpu变量。用于记录当前CPU当前进程的<code>struct task_struct</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">/// arch/arm64/kernel/process.c
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="cm"> * We store our current task in sp_el0, which is clobbered by userspace. Keep a
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="cm"> * shadow copy so that we can restore this upon entry from userspace.
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="cm"> * This is *only* for exception entry from EL0, and is not valid until we
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="cm"> * __switch_to() a user task.
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="nf">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">,</span> <span class="n">__entry_task</span><span class="p">);</span>
</span></span></code></pre></div>
<h4 id="4222-el1" data-numberify>4.2.2.2. EL1<a class="anchor ms-1" href="#4222-el1"></a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl">    <span class="p">.</span><span class="k">else</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="c1">/// sp + sizeof(struct pt_regs)，x21记录出现异常时的sp，后续会保存到pt_regs.sp
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"></span>    <span class="n">add</span>	<span class="n">x21</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">PT_REGS_SIZE</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="c1">/// 将sp_el0读到tsk，后边汇编代码可以用tsk来访问当前task_struct
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c1"></span>    <span class="n">get_current_task</span> <span class="n">tsk</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">    <span class="p">.</span><span class="n">endif</span> <span class="cm">/* \el == 0 */</span>
</span></span></code></pre></div>
<h3 id="423-寄存和栈配置" data-numberify>4.2.3. 寄存和栈配置<a class="anchor ms-1" href="#423-寄存和栈配置"></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl">    <span class="n">mrs</span>	<span class="n">x22</span><span class="p">,</span> <span class="n">elr_el1</span>            <span class="c1">/// 保存elr_el1
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span>    <span class="n">mrs</span>	<span class="n">x23</span><span class="p">,</span> <span class="n">spsr_el1</span>           <span class="c1">/// 保存spsr_el1
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"></span>    <span class="n">stp</span>	<span class="n">lr</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_LR</span><span class="p">]</span>    <span class="c1">/// lr和sp保存到pt_regs.regs[30](lr)和pt_regs.sp
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="cm">     * For exceptions from EL0, create a final frame record.
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="cm">     * For exceptions from EL1, create a synthetic frame record so the
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="cm">     * interrupted code shows up in the backtrace.
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="p">.</span><span class="k">if</span> <span class="err">\</span><span class="n">el</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="n">stp</span>	<span class="n">xzr</span><span class="p">,</span> <span class="n">xzr</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_STACKFRAME</span><span class="p">]</span>   <span class="c1">/// 清零pt_regs.stackframe[2]，用于终止栈回溯
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="k">else</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="n">stp</span>	<span class="n">x29</span><span class="p">,</span> <span class="n">x22</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_STACKFRAME</span><span class="p">]</span>   <span class="c1">/// 保存x29和x22(elr_el1)到pt_regs.stackframe[2]
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="n">endif</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="n">add</span>	<span class="n">x29</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_STACKFRAME</span>          <span class="c1">/// x29指向pt_regs.stackframe[2]
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="cp">#ifdef CONFIG_ARM64_SW_TTBR0_PAN
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="cp"></span>    <span class="c1">/// ... ...
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="n">stp</span>	<span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_PC</span><span class="p">]</span>           <span class="c1">/// 保存elr_el1和spsr_el1到pt_regs.pc和pt_regs.pstate
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="cm">/* Not in a syscall by default (el0_svc overwrites for real syscall) */</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="p">.</span><span class="k">if</span>	<span class="err">\</span><span class="n">el</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">    <span class="n">mov</span>	<span class="n">w21</span><span class="p">,</span> <span class="err">#</span><span class="n">NO_SYSCALL</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="n">str</span>	<span class="n">w21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_SYSCALLNO</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="p">.</span><span class="n">endif</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="cp">#ifdef CONFIG_ARM64_PSEUDO_NMI
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="cp"></span>    <span class="c1">/// ... ...
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="cm">     * Registers that may be useful after this macro is invoked:
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="cm">     * x20 - ICC_PMR_EL1
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="cm">     * x21 - aborted SP
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="cm">     * x22 - aborted PC
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="cm">     * x23 - aborted PSTATE
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">    <span class="p">.</span><span class="n">endm</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th>pt_regs.x</th>
<th style="text-align:center">reg(el1)</th>
<th style="text-align:center">reg(el0)</th>
</tr>
</thead>
<tbody>
<tr>
<td>regs[0]</td>
<td style="text-align:center">x0</td>
<td style="text-align:center">x0</td>
</tr>
<tr>
<td>regs[1]</td>
<td style="text-align:center">x1</td>
<td style="text-align:center">x1</td>
</tr>
<tr>
<td>&hellip;</td>
<td style="text-align:center">&hellip;</td>
<td style="text-align:center">&hellip;</td>
</tr>
<tr>
<td>regs[29]</td>
<td style="text-align:center">x29(fp)</td>
<td style="text-align:center">x29(fp)</td>
</tr>
<tr>
<td>regs[30]</td>
<td style="text-align:center">x30(lr)</td>
<td style="text-align:center">x30(lr)</td>
</tr>
<tr>
<td>sp</td>
<td style="text-align:center">sp + PT_REGS_SIZE</td>
<td style="text-align:center">sp_el0</td>
</tr>
<tr>
<td>pc</td>
<td style="text-align:center">elr_el1</td>
<td style="text-align:center">elr_el1</td>
</tr>
<tr>
<td>pstate</td>
<td style="text-align:center">spsr_el1</td>
<td style="text-align:center">spsr_el1</td>
</tr>
<tr>
<td>orig_x0</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>unused2</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td>syscallno</td>
<td style="text-align:center">-</td>
<td style="text-align:center">NO_SYSCALL</td>
</tr>
<tr>
<td>sdei_ttbr1</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td>pmr_save</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td>stackframe[0]</td>
<td style="text-align:center">x29</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td>stackframe[1]</td>
<td style="text-align:center">elr_el1</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td>lockdep_hardirqs</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td>exit_rcu</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<p>做完这些之后，就可以调用C语言的处理函数了。</p>

<h1 id="5-中断处理c语言函数" data-numberify>5. 中断处理C语言函数<a class="anchor ms-1" href="#5-中断处理c语言函数"></a></h1>
<p><code>arch/arm64/kernel/entry.S</code>中的汇编代码最终会调用到C语言的handler，这些函数在<code>arch/arm64/kernel/entry-common.c</code>中的定义，对应声明在<code>arch/arm64/include/asm/exception.h</code>中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">/// arch/arm64/include/asm/exception.h
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el1t_64_sync_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el1t_64_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el1t_64_fiq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el1t_64_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el1h_64_sync_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el1h_64_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el1h_64_fiq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el1h_64_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el0t_64_sync_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el0t_64_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el0t_64_fiq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el0t_64_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el0t_32_sync_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el0t_32_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el0t_32_fiq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">el0t_32_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</span></span></code></pre></div>
<h2 id="51-unhandled" data-numberify>5.1. UNHANDLED<a class="anchor ms-1" href="#51-unhandled"></a></h2>
<p>早期的Linux内核，在<code>vectors</code>直接调用不支持的的handler，比如<code>ventry	el1_sync_invalid</code>。在linux-6.6中，汇编部分做了通用化，而将差异放到了C语言代码中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">/// arch/arm64/kernel/entry-common.c
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1"></span><span class="cp">#define UNHANDLED(el, regsize, vector)							\
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="cp">asmlinkage void noinstr el##_##regsize##_##vector##_handler(struct pt_regs *regs)	\
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="cp">{											\
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="cp">    const char *desc = #regsize &#34;-bit &#34; #el &#34; &#34; #vector;				\
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="cp">    __panic_unhandled(regs, desc, read_sysreg(esr_el1));				\
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="cp">}
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="nf">UNHANDLED</span><span class="p">(</span><span class="n">el1t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">sync</span><span class="p">)</span>   <span class="c1">/// el1t_64_sync_handler
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1"></span><span class="nf">UNHANDLED</span><span class="p">(</span><span class="n">el1t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">irq</span><span class="p">)</span>    <span class="c1">/// el1t_64_irq_handler
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"></span><span class="nf">UNHANDLED</span><span class="p">(</span><span class="n">el1t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fiq</span><span class="p">)</span>    <span class="c1">/// el1t_64_fiq_handler
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"></span><span class="nf">UNHANDLED</span><span class="p">(</span><span class="n">el1t</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>  <span class="c1">/// el1t_64_error_handler
</span></span></span></code></pre></div><p>在未使能<code>CONFIG_COMPAT</code>的情况下，32位中断也是<code>UNHANDLED</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="cp">#ifdef CONFIG_COMPAT
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="cp"></span>    <span class="c1">/// ... ...
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"></span><span class="cp">#else </span><span class="cm">/* CONFIG_COMPAT */</span><span class="cp">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="cp"></span><span class="nf">UNHANDLED</span><span class="p">(</span><span class="n">el0t</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">sync</span><span class="p">)</span>   <span class="c1">/// el0t_32_sync_handler
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c1"></span><span class="nf">UNHANDLED</span><span class="p">(</span><span class="n">el0t</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">irq</span><span class="p">)</span>    <span class="c1">/// el0t_32_irq_handler
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="c1"></span><span class="nf">UNHANDLED</span><span class="p">(</span><span class="n">el0t</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">fiq</span><span class="p">)</span>    <span class="c1">/// el0t_32_fiq_handler
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="c1"></span><span class="nf">UNHANDLED</span><span class="p">(</span><span class="n">el0t</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>  <span class="c1">/// el0t_32_error_handler
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="c1"></span><span class="cp">#endif </span><span class="cm">/* CONFIG_COMPAT */</span><span class="cp">
</span></span></span></code></pre></div>
<h1 id="6-中断返回" data-numberify>6. 中断返回<a class="anchor ms-1" href="#6-中断返回"></a></h1>
<p>进行一些中断处理的收尾工作，<code>ret_to_kernel</code>和<code>ret_to_user</code>都是直接使用<code>kernel_exit</code>实现的。</p>

<h2 id="61-ret_to_kernel" data-numberify>6.1. ret_to_kernel<a class="anchor ms-1" href="#61-ret_to_kernel"></a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="nf">SYM_CODE_START_LOCAL</span><span class="p">(</span><span class="n">ret_to_kernel</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="n">kernel_exit</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="nf">SYM_CODE_END</span><span class="p">(</span><span class="n">ret_to_kernel</span><span class="p">)</span>
</span></span></code></pre></div>
<h2 id="62-ret_to_user" data-numberify>6.2. ret_to_user<a class="anchor ms-1" href="#62-ret_to_user"></a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nf">SYM_CODE_START_LOCAL</span><span class="p">(</span><span class="n">ret_to_user</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="c1">/// 加载thread_info.flags到x19
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"></span>    <span class="n">ldr</span>	<span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">tsk</span><span class="p">,</span> <span class="err">#</span><span class="n">TSK_TI_FLAGS</span><span class="p">]</span>	<span class="c1">// re-check for single-step
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"></span>    <span class="c1">/// call with daif masked
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"></span>    <span class="c1">/// 如果进程允许单步调试(TIF_SINGLESTEP)，开启MDSCR_EL1的软件单步控制(DBG_MDSCR_SS)
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"></span>    <span class="n">enable_step_tsk</span> <span class="n">x19</span><span class="p">,</span> <span class="n">x2</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="cp">#ifdef CONFIG_GCC_PLUGIN_STACKLEAK
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="cp"></span>    <span class="n">bl</span>	<span class="n">stackleak_erase_on_task_stack</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="cp"></span>    <span class="n">kernel_exit</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="nf">SYM_CODE_END</span><span class="p">(</span><span class="n">ret_to_user</span><span class="p">)</span>
</span></span></code></pre></div>
<h1 id="7-kernel_exit" data-numberify>7. kernel_exit<a class="anchor ms-1" href="#7-kernel_exit"></a></h1>

<h2 id="71-el0关闭daif" data-numberify>7.1. el0关闭daif<a class="anchor ms-1" href="#71-el0关闭daif"></a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">/// arch/arm64/kernel/entry.S
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="n">macro</span>	<span class="n">kernel_exit</span><span class="p">,</span> <span class="n">el</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="p">.</span><span class="k">if</span>	<span class="err">\</span><span class="n">el</span> <span class="o">!=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="n">disable_daif</span>        <span class="c1">/// 屏蔽中断
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="n">endif</span>
</span></span></code></pre></div>
<h2 id="72-从elr和spsr恢复" data-numberify>7.2. 从ELR和SPSR恢复<a class="anchor ms-1" href="#72-从elr和spsr恢复"></a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="cp">#ifdef CONFIG_ARM64_PSEUDO_NMI
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="cp"></span>    <span class="c1">/// ... ...
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x21</span><span class="p">,</span> <span class="n">x22</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_PC</span><span class="p">]</span>		<span class="c1">// load ELR, SPSR
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="cp">#ifdef CONFIG_ARM64_SW_TTBR0_PAN
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="cp"></span>    <span class="c1">/// ... ...
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span></code></pre></div>
<h2 id="73-el0栈空间处理" data-numberify>7.3. el0栈空间处理<a class="anchor ms-1" href="#73-el0栈空间处理"></a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl">    <span class="p">.</span><span class="k">if</span>	<span class="err">\</span><span class="n">el</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="n">ldr</span>	<span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_SP</span><span class="p">]</span>		<span class="c1">// load return stack pointer
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"></span>    <span class="n">msr</span>	<span class="n">sp_el0</span><span class="p">,</span> <span class="n">x23</span>             <span class="c1">/// 从栈中恢复sp_el0
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"></span>    <span class="n">tst</span>	<span class="n">x22</span><span class="p">,</span> <span class="err">#</span><span class="n">PSR_MODE32_BIT</span>		<span class="c1">// native task?
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"></span>    <span class="n">b</span><span class="p">.</span><span class="n">eq</span>	<span class="mf">3f</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="cp">#ifdef CONFIG_ARM64_ERRATUM_845719
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="cp"></span><span class="c1">/// ... ...
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="cp"></span><span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="n">scs_save</span> <span class="n">tsk</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="cm">/* Ignore asynchronous tag check faults in the uaccess routines */</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="n">ldr</span>	<span class="n">x0</span><span class="p">,</span> <span class="p">[</span><span class="n">tsk</span><span class="p">,</span> <span class="n">THREAD_SCTLR_USER</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="n">clear_mte_async_tcf</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="cp">#ifdef CONFIG_ARM64_PTR_AUTH
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="cp"></span><span class="c1">/// ... ...
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="n">mte_set_user_gcr</span> <span class="n">tsk</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="n">apply_ssbd</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="p">.</span><span class="n">endif</span>
</span></span></code></pre></div>
<h2 id="74-寄存器出栈" data-numberify>7.4. 寄存器出栈<a class="anchor ms-1" href="#74-寄存器出栈"></a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl">    <span class="c1">/// 前边从栈中恢复了ELR和SPSR到x21和x22
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span>    <span class="n">msr</span>	<span class="n">elr_el1</span><span class="p">,</span> <span class="n">x21</span>			<span class="c1">// set up the return data
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"></span>    <span class="n">msr</span>	<span class="n">spsr_el1</span><span class="p">,</span> <span class="n">x22</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="c1">/// 恢复通用寄存器x0~x29
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"></span>    <span class="n">ldp</span>	<span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x6</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x8</span><span class="p">,</span> <span class="n">x9</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x10</span><span class="p">,</span> <span class="n">x11</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x12</span><span class="p">,</span> <span class="n">x13</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x14</span><span class="p">,</span> <span class="n">x15</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">7</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x16</span><span class="p">,</span> <span class="n">x17</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x18</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">9</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x20</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">11</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x24</span><span class="p">,</span> <span class="n">x25</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">12</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x26</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">13</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="n">ldp</span>	<span class="n">x28</span><span class="p">,</span> <span class="n">x29</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">14</span><span class="p">]</span>
</span></span></code></pre></div>
<h2 id="75-el0和el1恢复" data-numberify>7.5. el0和el1恢复<a class="anchor ms-1" href="#75-el0和el1恢复"></a></h2>

<h3 id="751-el0" data-numberify>7.5.1. el0<a class="anchor ms-1" href="#751-el0"></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl">    <span class="p">.</span><span class="k">if</span>	<span class="err">\</span><span class="n">el</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">alternative_if</span> <span class="n">ARM64_WORKAROUND_2966298</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="n">tlbi</span>	<span class="n">vale1</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="n">dsb</span>	<span class="n">nsh</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">alternative_else_nop_endif</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">alternative_if_not</span> <span class="n">ARM64_UNMAP_KERNEL_AT_EL0</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="c1">/// 不使能KPTI(Kernel page table isolation) patch
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="c1"></span>    <span class="n">ldr</span>	<span class="n">lr</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_LR</span><span class="p">]</span>             <span class="c1">/// 中断处理过程中修改了lr，这时恢复用户态lr
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"></span>    <span class="n">add</span>	<span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">PT_REGS_SIZE</span>		<span class="c1">// restore sp
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"></span>    <span class="n">eret</span>                            <span class="c1">/// 从异常返回，继续从中断处执行
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span><span class="n">alternative_else_nop_endif</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="cp">#ifdef CONFIG_UNMAP_KERNEL_AT_EL0
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="cp"></span>    <span class="n">msr</span>	<span class="n">far_el1</span><span class="p">,</span> <span class="n">x29</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="n">ldr_this_cpu</span>	<span class="n">x30</span><span class="p">,</span> <span class="n">this_cpu_vector</span><span class="p">,</span> <span class="n">x29</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="n">tramp_alias</span>	<span class="n">x29</span><span class="p">,</span> <span class="n">tramp_exit</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="n">msr</span>		<span class="n">vbar_el1</span><span class="p">,</span> <span class="n">x30</span>		<span class="c1">// install vector table
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1"></span>    <span class="n">ldr</span>		<span class="n">lr</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_LR</span><span class="p">]</span>		<span class="c1">// restore x30
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="c1"></span>    <span class="n">add</span>		<span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">PT_REGS_SIZE</span>	<span class="c1">// restore sp
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="c1"></span>    <span class="n">br</span>		<span class="n">x29</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="cp">#endif
</span></span></span></code></pre></div>
<h3 id="752-el1" data-numberify>7.5.2. el1<a class="anchor ms-1" href="#752-el1"></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl">    <span class="p">.</span><span class="k">else</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="n">ldr</span>	<span class="n">lr</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_LR</span><span class="p">]</span>             <span class="c1">/// 中断处理过程中修改了lr，从栈中恢复lr
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"></span>    <span class="n">add</span>	<span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">PT_REGS_SIZE</span>		<span class="c1">// restore sp
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="cm">/* Ensure any device/NC reads complete */</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">    <span class="n">alternative_insn</span> <span class="n">nop</span><span class="p">,</span> <span class="s">&#34;dmb sy&#34;</span><span class="p">,</span> <span class="n">ARM64_WORKAROUND_1508412</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">
</span></span><span class="line"><span class="ln">8</span><span class="cl">    <span class="n">eret</span>                            <span class="c1">/// 从异常返回
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="n">endif</span>
</span></span></code></pre></div>
<h2 id="76-speculation-barrier" data-numberify>7.6. Speculation barrier<a class="anchor ms-1" href="#76-speculation-barrier"></a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl">    <span class="n">sb</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="p">.</span><span class="n">endm</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">/// arch/arm64/include/asm/assembler.h
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="cm"> * Speculation barrier
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="p">.</span><span class="n">macro</span>	<span class="n">sb</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">alternative_if_not</span> <span class="n">ARM64_HAS_SB</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="n">dsb</span>	<span class="n">nsh</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="n">isb</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">alternative_else</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="n">SB_BARRIER_INSN</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">alternative_endif</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="p">.</span><span class="n">endm</span>
</span></span></code></pre></div>
<h1 id="8-总结" data-numberify>8. 总结<a class="anchor ms-1" href="#8-总结"></a></h1>

<h2 id="81-daif状态切换" data-numberify>8.1. daif状态切换<a class="anchor ms-1" href="#81-daif状态切换"></a></h2>
<ol>
<li>发生异常时，硬件将<code>pstate.daif</code>保存到<code>spsr_el1</code>，屏蔽<code>daif</code>。</li>
<li>中断C函数中，关闭或部分/全部打开。</li>
<li>在kernel_exit中，如果是返回用户态中断，将daif关闭。</li>
<li>硬件从SPSR中恢复原daif状态。</li>
</ol>

<h2 id="82-sp和current" data-numberify>8.2. SP和current<a class="anchor ms-1" href="#82-sp和current"></a></h2>
<p>Linux内核运行在EL1，sp_el0压栈后，就可以用sp_el0来存放当前task_struct。</p>
<ol>
<li>对于<code>el0t_64</code>和<code>el0t_32</code>，是用户态中断，在陷入内核时，通过<code>msr sp_el0, tsk</code>将<code>sp_el0</code>指向了当前task_struct 。</li>
<li>对于<code>el1t_64</code>和<code>el1h_64</code>，是内核态中断，在发生中断前，要么是初始化阶段经设置<code>sp_el0</code>指向<code>init_task</code>，要么是从用户态陷入内核态，sp_el0也指向了当前task_struct 。</li>
</ol>
<p>ARM上中断栈和内核栈是共享的。每个进程/线程都有自己的内核栈，除<code>init_task</code>外，其他进程/线程在fork时会申请内存作为内核栈，并将<code>sp_el1</code>指向该内核栈，见<code>copy_thread</code>。而在进程第一次运行或被调度后，栈会向下增长。在发生中断时，就会使当前进程/线程的栈向下增长，在中断处理完成后，又逐步将栈还原。</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align:left">el1t_64</th>
<th style="text-align:left">el1h_64</th>
<th style="text-align:left">el0t_64</th>
<th style="text-align:left">el0t_32</th>
</tr>
</thead>
<tbody>
<tr>
<td>异常前使用的sp</td>
<td style="text-align:left">sp_el0</td>
<td style="text-align:left">sp_el1</td>
<td style="text-align:left">sp_el0</td>
<td style="text-align:left">sp_el0</td>
</tr>
<tr>
<td>kernel_ventry</td>
<td style="text-align:left">sp_el1 -= PT_REGS_SIZE</td>
<td style="text-align:left">sp_el1 -= PT_REGS_SIZE</td>
<td style="text-align:left">sp_el1 -= PT_REGS_SIZE</td>
<td style="text-align:left">sp_el1 -= PT_REGS_SIZE</td>
</tr>
<tr>
<td>kernel_entry</td>
<td style="text-align:left">add	x21, sp, #PT_REGS_SIZE</td>
<td style="text-align:left">add	x21, sp, #PT_REGS_SIZE</td>
<td style="text-align:left">mrs	x21, sp_el0</td>
<td style="text-align:left">mrs	x21, sp_el0</td>
</tr>
<tr>
<td>kernel_entry</td>
<td style="text-align:left">get_current_task tsk</td>
<td style="text-align:left">get_current_task tsk</td>
<td style="text-align:left">msr sp_el0, tsk</td>
<td style="text-align:left">msr sp_el0, tsk</td>
</tr>
<tr>
<td>kernel_entry</td>
<td style="text-align:left">stp	lr, x21, [sp, #S_LR]</td>
<td style="text-align:left">stp	lr, x21, [sp, #S_LR]</td>
<td style="text-align:left">stp	lr, x21, [sp, #S_LR]</td>
<td style="text-align:left">stp	lr, x21, [sp, #S_LR]</td>
</tr>
<tr>
<td>C语言handler</td>
<td style="text-align:left"></td>
<td style="text-align:left">current</td>
<td style="text-align:left">current</td>
<td style="text-align:left">current</td>
</tr>
<tr>
<td>kernel_exit</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">ldr	x23, [sp, #S_SP]</td>
<td style="text-align:left">ldr	x23, [sp, #S_SP]</td>
</tr>
<tr>
<td>kernel_exit</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">msr	sp_el0, x23</td>
<td style="text-align:left">msr	sp_el0, x23</td>
</tr>
<tr>
<td>kernel_exit</td>
<td style="text-align:left">sp_el1 += PT_REGS_SIZE</td>
<td style="text-align:left">sp_el1 += PT_REGS_SIZE</td>
<td style="text-align:left">sp_el1 += PT_REGS_SIZE</td>
<td style="text-align:left">sp_el1 += PT_REGS_SIZE</td>
</tr>
</tbody>
</table>

<h1 id="9-反汇编" data-numberify>9. 反汇编<a class="anchor ms-1" href="#9-反汇编"></a></h1>
<p>这里给出ARM64 vmlinux的反汇编，方便对比源码和最终的指令。</p>

<h2 id="91-vectors" data-numberify>9.1. vectors<a class="anchor ms-1" href="#91-vectors"></a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">ffff800080011000</span> <span class="o">&lt;</span><span class="n">vectors</span><span class="o">&gt;:</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nf">vectors</span><span class="p">()</span><span class="o">:</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">linux</span><span class="o">-</span><span class="mf">6.6</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">entry</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">517</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1">/// 由kernel_ventry宏生成
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011000</span><span class="p">:</span>   <span class="n">d10543ff</span>    <span class="n">sub</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x150</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="nl">ffff800080011004</span><span class="p">:</span>   <span class="mi">8</span><span class="n">b2063ff</span>    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="nl">ffff800080011008</span><span class="p">:</span>   <span class="n">cb2063e0</span>    <span class="n">sub</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="nl">ffff80008001100c</span><span class="p">:</span>   <span class="mi">37700080</span>    <span class="n">tbnz</span>    <span class="n">w0</span><span class="p">,</span> <span class="err">#</span><span class="mi">14</span><span class="p">,</span> <span class="n">ffff80008001101c</span> <span class="o">&lt;</span><span class="n">vectors</span><span class="o">+</span><span class="mh">0x1c</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="nl">ffff800080011010</span><span class="p">:</span>   <span class="n">cb2063e0</span>    <span class="n">sub</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="nl">ffff800080011014</span><span class="p">:</span>   <span class="n">cb2063ff</span>    <span class="n">sub</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1">/// el1t_64_sync由entry_handler声明
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011018</span><span class="p">:</span>   <span class="mi">1400021</span><span class="n">e</span>    <span class="n">b</span>   <span class="n">ffff800080011890</span> <span class="o">&lt;</span><span class="n">el1t_64_sync</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="nl">ffff80008001101c</span><span class="p">:</span>   <span class="n">d51bd040</span>    <span class="n">msr</span> <span class="n">tpidr_el0</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="nl">ffff800080011020</span><span class="p">:</span>   <span class="n">cb2063e0</span>    <span class="n">sub</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="nl">ffff800080011024</span><span class="p">:</span>   <span class="n">d51bd060</span>    <span class="n">msr</span> <span class="n">tpidrro_el0</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="nl">ffff800080011028</span><span class="p">:</span>   <span class="n">f000aec0</span>    <span class="n">adrp</span>    <span class="n">x0</span><span class="p">,</span> <span class="n">ffff8000815ec000</span> <span class="o">&lt;</span><span class="n">overflow_stack</span><span class="o">+</span><span class="mh">0xcf0</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="nl">ffff80008001102c</span><span class="p">:</span>   <span class="mi">910</span><span class="n">c401f</span>    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x310</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="nl">ffff800080011030</span><span class="p">:</span>   <span class="n">d538d080</span>    <span class="n">mrs</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tpidr_el1</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="nl">ffff800080011034</span><span class="p">:</span>   <span class="mi">8</span><span class="n">b2063ff</span>    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="nl">ffff800080011038</span><span class="p">:</span>   <span class="n">d53bd040</span>    <span class="n">mrs</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tpidr_el0</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="nl">ffff80008001103c</span><span class="p">:</span>   <span class="n">cb2063e0</span>    <span class="n">sub</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="nl">ffff800080011040</span><span class="p">:</span>   <span class="n">f274cc1f</span>    <span class="n">tst</span> <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xfffffffffffff000</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="nl">ffff800080011044</span><span class="p">:</span>   <span class="mi">54003</span><span class="n">de1</span>    <span class="n">b</span><span class="p">.</span><span class="n">ne</span>    <span class="n">ffff800080011800</span> <span class="o">&lt;</span><span class="n">__bad_stack</span><span class="o">&gt;</span>  <span class="c1">// b.any
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011048</span><span class="p">:</span>   <span class="n">cb2063ff</span>    <span class="n">sub</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="nl">ffff80008001104c</span><span class="p">:</span>   <span class="n">d53bd060</span>    <span class="n">mrs</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tpidrro_el0</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="nl">ffff800080011050</span><span class="p">:</span>   <span class="mi">14000210</span>    <span class="n">b</span>   <span class="n">ffff800080011890</span> <span class="o">&lt;</span><span class="n">el1t_64_sync</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="n">linux</span><span class="o">-</span><span class="mf">6.6</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">entry</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">518</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="nl">ffff800080011080</span><span class="p">:</span>   <span class="n">d10543ff</span>    <span class="n">sub</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x150</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="nl">ffff800080011084</span><span class="p">:</span>   <span class="mi">8</span><span class="n">b2063ff</span>    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="nl">ffff800080011088</span><span class="p">:</span>   <span class="n">cb2063e0</span>    <span class="n">sub</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="nl">ffff80008001108c</span><span class="p">:</span>   <span class="mi">37700080</span>    <span class="n">tbnz</span>    <span class="n">w0</span><span class="p">,</span> <span class="err">#</span><span class="mi">14</span><span class="p">,</span> <span class="n">ffff80008001109c</span> <span class="o">&lt;</span><span class="n">vectors</span><span class="o">+</span><span class="mh">0x9c</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="nl">ffff800080011090</span><span class="p">:</span>   <span class="n">cb2063e0</span>    <span class="n">sub</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="nl">ffff800080011094</span><span class="p">:</span>   <span class="n">cb2063ff</span>    <span class="n">sub</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="nl">ffff800080011098</span><span class="p">:</span>   <span class="mi">1400021</span><span class="n">e</span>    <span class="n">b</span>   <span class="n">ffff800080011910</span> <span class="o">&lt;</span><span class="n">el1t_64_irq</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="nl">ffff80008001109c</span><span class="p">:</span>   <span class="n">d51bd040</span>    <span class="n">msr</span> <span class="n">tpidr_el0</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="nl">ffff8000800110a0</span><span class="p">:</span>   <span class="n">cb2063e0</span>    <span class="n">sub</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="nl">ffff8000800110a4</span><span class="p">:</span>   <span class="n">d51bd060</span>    <span class="n">msr</span> <span class="n">tpidrro_el0</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="nl">ffff8000800110a8</span><span class="p">:</span>   <span class="n">f000aec0</span>    <span class="n">adrp</span>    <span class="n">x0</span><span class="p">,</span> <span class="n">ffff8000815ec000</span> <span class="o">&lt;</span><span class="n">overflow_stack</span><span class="o">+</span><span class="mh">0xcf0</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="nl">ffff8000800110ac</span><span class="p">:</span>   <span class="mi">910</span><span class="n">c401f</span>    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x310</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="nl">ffff8000800110b0</span><span class="p">:</span>   <span class="n">d538d080</span>    <span class="n">mrs</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tpidr_el1</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="nl">ffff8000800110b4</span><span class="p">:</span>   <span class="mi">8</span><span class="n">b2063ff</span>    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="nl">ffff8000800110b8</span><span class="p">:</span>   <span class="n">d53bd040</span>    <span class="n">mrs</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tpidr_el0</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="nl">ffff8000800110bc</span><span class="p">:</span>   <span class="n">cb2063e0</span>    <span class="n">sub</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="nl">ffff8000800110c0</span><span class="p">:</span>   <span class="n">f274cc1f</span>    <span class="n">tst</span> <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xfffffffffffff000</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="nl">ffff8000800110c4</span><span class="p">:</span>   <span class="mf">540039e1</span>    <span class="n">b</span><span class="p">.</span><span class="n">ne</span>    <span class="n">ffff800080011800</span> <span class="o">&lt;</span><span class="n">__bad_stack</span><span class="o">&gt;</span>  <span class="c1">// b.any
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="c1"></span><span class="nl">ffff8000800110c8</span><span class="p">:</span>   <span class="n">cb2063ff</span>    <span class="n">sub</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="nl">ffff8000800110cc</span><span class="p">:</span>   <span class="n">d53bd060</span>    <span class="n">mrs</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tpidrro_el0</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="nl">ffff8000800110d0</span><span class="p">:</span>   <span class="mi">14000210</span>    <span class="n">b</span>   <span class="n">ffff800080011910</span> <span class="o">&lt;</span><span class="n">el1t_64_irq</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">
</span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="c1">/// ... ...
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="c1"></span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">eel</span><span class="o">/</span><span class="n">source</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">linux</span><span class="o">-</span><span class="mf">6.6</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">entry</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">527</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="nl">ffff800080011400</span><span class="p">:</span>   <span class="mi">14000003</span>    <span class="n">b</span>   <span class="n">ffff80008001140c</span> <span class="o">&lt;</span><span class="n">vectors</span><span class="o">+</span><span class="mh">0x40c</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="nl">ffff800080011404</span><span class="p">:</span>   <span class="n">d53bd07e</span>    <span class="n">mrs</span> <span class="n">x30</span><span class="p">,</span> <span class="n">tpidrro_el0</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="nl">ffff800080011408</span><span class="p">:</span>   <span class="n">d51bd07f</span>    <span class="n">msr</span> <span class="n">tpidrro_el0</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="nl">ffff80008001140c</span><span class="p">:</span>   <span class="n">d10543ff</span>    <span class="n">sub</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x150</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="nl">ffff800080011410</span><span class="p">:</span>   <span class="mi">8</span><span class="n">b2063ff</span>    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="nl">ffff800080011414</span><span class="p">:</span>   <span class="n">cb2063e0</span>    <span class="n">sub</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="nl">ffff800080011418</span><span class="p">:</span>   <span class="mi">37700080</span>    <span class="n">tbnz</span>    <span class="n">w0</span><span class="p">,</span> <span class="err">#</span><span class="mi">14</span><span class="p">,</span> <span class="n">ffff800080011428</span> <span class="o">&lt;</span><span class="n">vectors</span><span class="o">+</span><span class="mh">0x428</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="nl">ffff80008001141c</span><span class="p">:</span>   <span class="n">cb2063e0</span>    <span class="n">sub</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="nl">ffff800080011420</span><span class="p">:</span>   <span class="n">cb2063ff</span>    <span class="n">sub</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="nl">ffff800080011424</span><span class="p">:</span>   <span class="mi">1400021</span><span class="n">b</span>    <span class="n">b</span>   <span class="n">ffff800080011c90</span> <span class="o">&lt;</span><span class="n">el0t_64_sync</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="nl">ffff800080011428</span><span class="p">:</span>   <span class="n">d51bd040</span>    <span class="n">msr</span> <span class="n">tpidr_el0</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="nl">ffff80008001142c</span><span class="p">:</span>   <span class="n">cb2063e0</span>    <span class="n">sub</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="nl">ffff800080011430</span><span class="p">:</span>   <span class="n">d51bd060</span>    <span class="n">msr</span> <span class="n">tpidrro_el0</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="nl">ffff800080011434</span><span class="p">:</span>   <span class="n">f000aec0</span>    <span class="n">adrp</span>    <span class="n">x0</span><span class="p">,</span> <span class="n">ffff8000815ec000</span> <span class="o">&lt;</span><span class="n">overflow_stack</span><span class="o">+</span><span class="mh">0xcf0</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="nl">ffff800080011438</span><span class="p">:</span>   <span class="mi">910</span><span class="n">c401f</span>    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x310</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="nl">ffff80008001143c</span><span class="p">:</span>   <span class="n">d538d080</span>    <span class="n">mrs</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tpidr_el1</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="nl">ffff800080011440</span><span class="p">:</span>   <span class="mi">8</span><span class="n">b2063ff</span>    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="nl">ffff800080011444</span><span class="p">:</span>   <span class="n">d53bd040</span>    <span class="n">mrs</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tpidr_el0</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="nl">ffff800080011448</span><span class="p">:</span>   <span class="n">cb2063e0</span>    <span class="n">sub</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="nl">ffff80008001144c</span><span class="p">:</span>   <span class="n">f274cc1f</span>    <span class="n">tst</span> <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xfffffffffffff000</span>
</span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="nl">ffff800080011450</span><span class="p">:</span>   <span class="mi">54001</span><span class="n">d81</span>    <span class="n">b</span><span class="p">.</span><span class="n">ne</span>    <span class="n">ffff800080011800</span> <span class="o">&lt;</span><span class="n">__bad_stack</span><span class="o">&gt;</span>  <span class="c1">// b.any
</span></span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011454</span><span class="p">:</span>   <span class="n">cb2063ff</span>    <span class="n">sub</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span>
</span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="nl">ffff800080011458</span><span class="p">:</span>   <span class="n">d53bd060</span>    <span class="n">mrs</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tpidrro_el0</span>
</span></span><span class="line"><span class="ln">76</span><span class="cl"><span class="nl">ffff80008001145c</span><span class="p">:</span>   <span class="mi">1400020</span><span class="n">d</span>    <span class="n">b</span>   <span class="n">ffff800080011c90</span> <span class="o">&lt;</span><span class="n">el0t_64_sync</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">77</span><span class="cl">    <span class="p">...</span>
</span></span></code></pre></div>
<h2 id="92-el1t_64_sync和el1t_64_irq" data-numberify>9.2. el1t_64_sync和el1t_64_irq<a class="anchor ms-1" href="#92-el1t_64_sync和el1t_64_irq"></a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">/// el1t_64_sync由entry_handler声明
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span><span class="n">ffff800080011890</span> <span class="o">&lt;</span><span class="n">el1t_64_sync</span><span class="o">&gt;:</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nf">el1t_64_sync</span><span class="p">()</span><span class="o">:</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">linux</span><span class="o">-</span><span class="mf">6.6</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">entry</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">585</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1">/// kernel_entry生成
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011890</span><span class="p">:</span>   <span class="n">a90007e0</span>    <span class="n">stp</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="nl">ffff800080011894</span><span class="p">:</span>   <span class="n">a9010fe2</span>    <span class="n">stp</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="nl">ffff800080011898</span><span class="p">:</span>   <span class="n">a90217e4</span>    <span class="n">stp</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">32</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="nl">ffff80008001189c</span><span class="p">:</span>   <span class="n">a9031fe6</span>    <span class="n">stp</span> <span class="n">x6</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">48</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="nl">ffff8000800118a0</span><span class="p">:</span>   <span class="n">a90427e8</span>    <span class="n">stp</span> <span class="n">x8</span><span class="p">,</span> <span class="n">x9</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">64</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="nl">ffff8000800118a4</span><span class="p">:</span>   <span class="n">a9052fea</span>    <span class="n">stp</span> <span class="n">x10</span><span class="p">,</span> <span class="n">x11</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">80</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="nl">ffff8000800118a8</span><span class="p">:</span>   <span class="n">a90637ec</span>    <span class="n">stp</span> <span class="n">x12</span><span class="p">,</span> <span class="n">x13</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">96</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="nl">ffff8000800118ac</span><span class="p">:</span>   <span class="n">a9073fee</span>    <span class="n">stp</span> <span class="n">x14</span><span class="p">,</span> <span class="n">x15</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">112</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="nl">ffff8000800118b0</span><span class="p">:</span>   <span class="n">a90847f0</span>    <span class="n">stp</span> <span class="n">x16</span><span class="p">,</span> <span class="n">x17</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">128</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="nl">ffff8000800118b4</span><span class="p">:</span>   <span class="n">a9094ff2</span>    <span class="n">stp</span> <span class="n">x18</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">144</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="nl">ffff8000800118b8</span><span class="p">:</span>   <span class="n">a90a57f4</span>    <span class="n">stp</span> <span class="n">x20</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">160</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="nl">ffff8000800118bc</span><span class="p">:</span>   <span class="n">a90b5ff6</span>    <span class="n">stp</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">176</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="nl">ffff8000800118c0</span><span class="p">:</span>   <span class="n">a90c67f8</span>    <span class="n">stp</span> <span class="n">x24</span><span class="p">,</span> <span class="n">x25</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">192</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="nl">ffff8000800118c4</span><span class="p">:</span>   <span class="n">a90d6ffa</span>    <span class="n">stp</span> <span class="n">x26</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">208</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="nl">ffff8000800118c8</span><span class="p">:</span>   <span class="n">a90e77fc</span>    <span class="n">stp</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x29</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">224</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="nl">ffff8000800118cc</span><span class="p">:</span>   <span class="mf">910543f</span><span class="mi">5</span>    <span class="n">add</span> <span class="n">x21</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x150</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="nl">ffff8000800118d0</span><span class="p">:</span>   <span class="n">d538411c</span>    <span class="n">mrs</span> <span class="n">x28</span><span class="p">,</span> <span class="n">sp_el0</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="nl">ffff8000800118d4</span><span class="p">:</span>   <span class="n">d5384036</span>    <span class="n">mrs</span> <span class="n">x22</span><span class="p">,</span> <span class="n">elr_el1</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="nl">ffff8000800118d8</span><span class="p">:</span>   <span class="n">d5384017</span>    <span class="n">mrs</span> <span class="n">x23</span><span class="p">,</span> <span class="n">spsr_el1</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="nl">ffff8000800118dc</span><span class="p">:</span>   <span class="n">a90f57fe</span>    <span class="n">stp</span> <span class="n">x30</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">240</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="nl">ffff8000800118e0</span><span class="p">:</span>   <span class="n">a9135bfd</span>    <span class="n">stp</span> <span class="n">x29</span><span class="p">,</span> <span class="n">x22</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">304</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="nl">ffff8000800118e4</span><span class="p">:</span>   <span class="mi">9104</span><span class="n">c3fd</span>    <span class="n">add</span> <span class="n">x29</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x130</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="nl">ffff8000800118e8</span><span class="p">:</span>   <span class="n">a9105ff6</span>    <span class="n">stp</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">256</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="nl">ffff8000800118ec</span><span class="p">:</span>   <span class="mi">14000005</span>    <span class="n">b</span>   <span class="n">ffff800080011900</span> <span class="o">&lt;</span><span class="n">el1t_64_sync</span><span class="o">+</span><span class="mh">0x70</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="nl">ffff8000800118f0</span><span class="p">:</span>   <span class="n">d5384614</span>    <span class="n">mrs</span> <span class="n">x20</span><span class="p">,</span> <span class="n">s3_0_c4_c6_0</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="nl">ffff8000800118f4</span><span class="p">:</span>   <span class="n">f90097f4</span>    <span class="n">str</span> <span class="n">x20</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">296</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="nl">ffff8000800118f8</span><span class="p">:</span>   <span class="n">d2801e14</span>    <span class="n">mov</span> <span class="n">x20</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xf0</span>                      <span class="c1">// #240
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="c1"></span><span class="nl">ffff8000800118fc</span><span class="p">:</span>   <span class="n">d5184614</span>    <span class="n">msr</span> <span class="n">s3_0_c4_c6_0</span><span class="p">,</span> <span class="n">x20</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="nl">ffff800080011900</span><span class="p">:</span>   <span class="mf">910003e0</span>    <span class="n">mov</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="c1">/// 调用C语言处理函数
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011904</span><span class="p">:</span>   <span class="mi">94364225</span>    <span class="n">bl</span>  <span class="n">ffff800080da2198</span> <span class="o">&lt;</span><span class="n">el1t_64_sync_handler</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="c1">/// 中断返回
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011908</span><span class="p">:</span>   <span class="mi">1400043</span><span class="n">a</span>    <span class="n">b</span>   <span class="n">ffff8000800129f0</span> <span class="o">&lt;</span><span class="n">ret_to_kernel</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="nl">ffff80008001190c</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="n">ffff800080011910</span> <span class="o">&lt;</span><span class="n">el1t_64_irq</span><span class="o">&gt;:</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="nf">el1t_64_irq</span><span class="p">()</span><span class="o">:</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="n">linux</span><span class="o">-</span><span class="mf">6.6</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">entry</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">586</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="nl">ffff800080011910</span><span class="p">:</span>   <span class="n">a90007e0</span>    <span class="n">stp</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="nl">ffff800080011914</span><span class="p">:</span>   <span class="n">a9010fe2</span>    <span class="n">stp</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="nl">ffff800080011918</span><span class="p">:</span>   <span class="n">a90217e4</span>    <span class="n">stp</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">32</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="nl">ffff80008001191c</span><span class="p">:</span>   <span class="n">a9031fe6</span>    <span class="n">stp</span> <span class="n">x6</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">48</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="nl">ffff800080011920</span><span class="p">:</span>   <span class="n">a90427e8</span>    <span class="n">stp</span> <span class="n">x8</span><span class="p">,</span> <span class="n">x9</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">64</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="nl">ffff800080011924</span><span class="p">:</span>   <span class="n">a9052fea</span>    <span class="n">stp</span> <span class="n">x10</span><span class="p">,</span> <span class="n">x11</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">80</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="nl">ffff800080011928</span><span class="p">:</span>   <span class="n">a90637ec</span>    <span class="n">stp</span> <span class="n">x12</span><span class="p">,</span> <span class="n">x13</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">96</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="nl">ffff80008001192c</span><span class="p">:</span>   <span class="n">a9073fee</span>    <span class="n">stp</span> <span class="n">x14</span><span class="p">,</span> <span class="n">x15</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">112</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="nl">ffff800080011930</span><span class="p">:</span>   <span class="n">a90847f0</span>    <span class="n">stp</span> <span class="n">x16</span><span class="p">,</span> <span class="n">x17</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">128</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="nl">ffff800080011934</span><span class="p">:</span>   <span class="n">a9094ff2</span>    <span class="n">stp</span> <span class="n">x18</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">144</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="nl">ffff800080011938</span><span class="p">:</span>   <span class="n">a90a57f4</span>    <span class="n">stp</span> <span class="n">x20</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">160</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="nl">ffff80008001193c</span><span class="p">:</span>   <span class="n">a90b5ff6</span>    <span class="n">stp</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">176</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="nl">ffff800080011940</span><span class="p">:</span>   <span class="n">a90c67f8</span>    <span class="n">stp</span> <span class="n">x24</span><span class="p">,</span> <span class="n">x25</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">192</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="nl">ffff800080011944</span><span class="p">:</span>   <span class="n">a90d6ffa</span>    <span class="n">stp</span> <span class="n">x26</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">208</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="nl">ffff800080011948</span><span class="p">:</span>   <span class="n">a90e77fc</span>    <span class="n">stp</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x29</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">224</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="nl">ffff80008001194c</span><span class="p">:</span>   <span class="mf">910543f</span><span class="mi">5</span>    <span class="n">add</span> <span class="n">x21</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x150</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="nl">ffff800080011950</span><span class="p">:</span>   <span class="n">d538411c</span>    <span class="n">mrs</span> <span class="n">x28</span><span class="p">,</span> <span class="n">sp_el0</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="nl">ffff800080011954</span><span class="p">:</span>   <span class="n">d5384036</span>    <span class="n">mrs</span> <span class="n">x22</span><span class="p">,</span> <span class="n">elr_el1</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="nl">ffff800080011958</span><span class="p">:</span>   <span class="n">d5384017</span>    <span class="n">mrs</span> <span class="n">x23</span><span class="p">,</span> <span class="n">spsr_el1</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="nl">ffff80008001195c</span><span class="p">:</span>   <span class="n">a90f57fe</span>    <span class="n">stp</span> <span class="n">x30</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">240</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="nl">ffff800080011960</span><span class="p">:</span>   <span class="n">a9135bfd</span>    <span class="n">stp</span> <span class="n">x29</span><span class="p">,</span> <span class="n">x22</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">304</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="nl">ffff800080011964</span><span class="p">:</span>   <span class="mi">9104</span><span class="n">c3fd</span>    <span class="n">add</span> <span class="n">x29</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x130</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="nl">ffff800080011968</span><span class="p">:</span>   <span class="n">a9105ff6</span>    <span class="n">stp</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">256</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="nl">ffff80008001196c</span><span class="p">:</span>   <span class="mi">14000005</span>    <span class="n">b</span>   <span class="n">ffff800080011980</span> <span class="o">&lt;</span><span class="n">el1t_64_irq</span><span class="o">+</span><span class="mh">0x70</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="nl">ffff800080011970</span><span class="p">:</span>   <span class="n">d5384614</span>    <span class="n">mrs</span> <span class="n">x20</span><span class="p">,</span> <span class="n">s3_0_c4_c6_0</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="nl">ffff800080011974</span><span class="p">:</span>   <span class="n">f90097f4</span>    <span class="n">str</span> <span class="n">x20</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">296</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="nl">ffff800080011978</span><span class="p">:</span>   <span class="n">d2801e14</span>    <span class="n">mov</span> <span class="n">x20</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xf0</span>                      <span class="c1">// #240
</span></span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="c1"></span><span class="nl">ffff80008001197c</span><span class="p">:</span>   <span class="n">d5184614</span>    <span class="n">msr</span> <span class="n">s3_0_c4_c6_0</span><span class="p">,</span> <span class="n">x20</span>
</span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="nl">ffff800080011980</span><span class="p">:</span>   <span class="mf">910003e0</span>    <span class="n">mov</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span>
</span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="c1">/// 调用C语言处理函数
</span></span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011984</span><span class="p">:</span>   <span class="mi">9436420</span><span class="n">d</span>    <span class="n">bl</span>  <span class="n">ffff800080da21b8</span> <span class="o">&lt;</span><span class="n">el1t_64_irq_handler</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="c1">/// 中断返回
</span></span></span><span class="line"><span class="ln">76</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011988</span><span class="p">:</span>   <span class="mi">1400041</span><span class="n">a</span>    <span class="n">b</span>   <span class="n">ffff8000800129f0</span> <span class="o">&lt;</span><span class="n">ret_to_kernel</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">77</span><span class="cl"><span class="nl">ffff80008001198c</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span></code></pre></div>
<h2 id="93-el0t_64_sync" data-numberify>9.3. el0t_64_sync<a class="anchor ms-1" href="#93-el0t_64_sync"></a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">  1</span><span class="cl"><span class="n">ffff800080011c90</span> <span class="o">&lt;</span><span class="n">el0t_64_sync</span><span class="o">&gt;:</span>
</span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="nf">el0t_64_sync</span><span class="p">()</span><span class="o">:</span>
</span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="n">linux</span><span class="o">-</span><span class="mf">6.6</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">entry</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">595</span>
</span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="nl">ffff800080011c90</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="nl">ffff800080011c94</span><span class="p">:</span>   <span class="n">a90007e0</span>    <span class="n">stp</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="nl">ffff800080011c98</span><span class="p">:</span>   <span class="n">a9010fe2</span>    <span class="n">stp</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="nl">ffff800080011c9c</span><span class="p">:</span>   <span class="n">a90217e4</span>    <span class="n">stp</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">32</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="nl">ffff800080011ca0</span><span class="p">:</span>   <span class="n">a9031fe6</span>    <span class="n">stp</span> <span class="n">x6</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">48</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="nl">ffff800080011ca4</span><span class="p">:</span>   <span class="n">a90427e8</span>    <span class="n">stp</span> <span class="n">x8</span><span class="p">,</span> <span class="n">x9</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">64</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="nl">ffff800080011ca8</span><span class="p">:</span>   <span class="n">a9052fea</span>    <span class="n">stp</span> <span class="n">x10</span><span class="p">,</span> <span class="n">x11</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">80</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="nl">ffff800080011cac</span><span class="p">:</span>   <span class="n">a90637ec</span>    <span class="n">stp</span> <span class="n">x12</span><span class="p">,</span> <span class="n">x13</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">96</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="nl">ffff800080011cb0</span><span class="p">:</span>   <span class="n">a9073fee</span>    <span class="n">stp</span> <span class="n">x14</span><span class="p">,</span> <span class="n">x15</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">112</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="nl">ffff800080011cb4</span><span class="p">:</span>   <span class="n">a90847f0</span>    <span class="n">stp</span> <span class="n">x16</span><span class="p">,</span> <span class="n">x17</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">128</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="nl">ffff800080011cb8</span><span class="p">:</span>   <span class="n">a9094ff2</span>    <span class="n">stp</span> <span class="n">x18</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">144</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="nl">ffff800080011cbc</span><span class="p">:</span>   <span class="n">a90a57f4</span>    <span class="n">stp</span> <span class="n">x20</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">160</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="nl">ffff800080011cc0</span><span class="p">:</span>   <span class="n">a90b5ff6</span>    <span class="n">stp</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">176</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="nl">ffff800080011cc4</span><span class="p">:</span>   <span class="n">a90c67f8</span>    <span class="n">stp</span> <span class="n">x24</span><span class="p">,</span> <span class="n">x25</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">192</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="nl">ffff800080011cc8</span><span class="p">:</span>   <span class="n">a90d6ffa</span>    <span class="n">stp</span> <span class="n">x26</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">208</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="nl">ffff800080011ccc</span><span class="p">:</span>   <span class="n">a90e77fc</span>    <span class="n">stp</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x29</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">224</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="c1">/// 用户态中断，重置部分通用寄存器
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011cd0</span><span class="p">:</span>   <span class="n">aa1f03e0</span>    <span class="n">mov</span> <span class="n">x0</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="nl">ffff800080011cd4</span><span class="p">:</span>   <span class="n">aa1f03e1</span>    <span class="n">mov</span> <span class="n">x1</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="nl">ffff800080011cd8</span><span class="p">:</span>   <span class="n">aa1f03e2</span>    <span class="n">mov</span> <span class="n">x2</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="nl">ffff800080011cdc</span><span class="p">:</span>   <span class="n">aa1f03e3</span>    <span class="n">mov</span> <span class="n">x3</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="nl">ffff800080011ce0</span><span class="p">:</span>   <span class="n">aa1f03e4</span>    <span class="n">mov</span> <span class="n">x4</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="nl">ffff800080011ce4</span><span class="p">:</span>   <span class="n">aa1f03e5</span>    <span class="n">mov</span> <span class="n">x5</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="nl">ffff800080011ce8</span><span class="p">:</span>   <span class="n">aa1f03e6</span>    <span class="n">mov</span> <span class="n">x6</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="nl">ffff800080011cec</span><span class="p">:</span>   <span class="n">aa1f03e7</span>    <span class="n">mov</span> <span class="n">x7</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="nl">ffff800080011cf0</span><span class="p">:</span>   <span class="n">aa1f03e8</span>    <span class="n">mov</span> <span class="n">x8</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="nl">ffff800080011cf4</span><span class="p">:</span>   <span class="n">aa1f03e9</span>    <span class="n">mov</span> <span class="n">x9</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="nl">ffff800080011cf8</span><span class="p">:</span>   <span class="n">aa1f03ea</span>    <span class="n">mov</span> <span class="n">x10</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="nl">ffff800080011cfc</span><span class="p">:</span>   <span class="n">aa1f03eb</span>    <span class="n">mov</span> <span class="n">x11</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="nl">ffff800080011d00</span><span class="p">:</span>   <span class="n">aa1f03ec</span>    <span class="n">mov</span> <span class="n">x12</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="nl">ffff800080011d04</span><span class="p">:</span>   <span class="n">aa1f03ed</span>    <span class="n">mov</span> <span class="n">x13</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="nl">ffff800080011d08</span><span class="p">:</span>   <span class="n">aa1f03ee</span>    <span class="n">mov</span> <span class="n">x14</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="nl">ffff800080011d0c</span><span class="p">:</span>   <span class="n">aa1f03ef</span>    <span class="n">mov</span> <span class="n">x15</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="nl">ffff800080011d10</span><span class="p">:</span>   <span class="n">aa1f03f0</span>    <span class="n">mov</span> <span class="n">x16</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="nl">ffff800080011d14</span><span class="p">:</span>   <span class="n">aa1f03f1</span>    <span class="n">mov</span> <span class="n">x17</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="nl">ffff800080011d18</span><span class="p">:</span>   <span class="n">aa1f03f2</span>    <span class="n">mov</span> <span class="n">x18</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="nl">ffff800080011d1c</span><span class="p">:</span>   <span class="n">aa1f03f3</span>    <span class="n">mov</span> <span class="n">x19</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="nl">ffff800080011d20</span><span class="p">:</span>   <span class="n">aa1f03f4</span>    <span class="n">mov</span> <span class="n">x20</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="nl">ffff800080011d24</span><span class="p">:</span>   <span class="n">aa1f03f5</span>    <span class="n">mov</span> <span class="n">x21</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="nl">ffff800080011d28</span><span class="p">:</span>   <span class="n">aa1f03f6</span>    <span class="n">mov</span> <span class="n">x22</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="nl">ffff800080011d2c</span><span class="p">:</span>   <span class="n">aa1f03f7</span>    <span class="n">mov</span> <span class="n">x23</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="nl">ffff800080011d30</span><span class="p">:</span>   <span class="n">aa1f03f8</span>    <span class="n">mov</span> <span class="n">x24</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="nl">ffff800080011d34</span><span class="p">:</span>   <span class="n">aa1f03f9</span>    <span class="n">mov</span> <span class="n">x25</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="nl">ffff800080011d38</span><span class="p">:</span>   <span class="n">aa1f03fa</span>    <span class="n">mov</span> <span class="n">x26</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="nl">ffff800080011d3c</span><span class="p">:</span>   <span class="n">aa1f03fb</span>    <span class="n">mov</span> <span class="n">x27</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="nl">ffff800080011d40</span><span class="p">:</span>   <span class="n">aa1f03fc</span>    <span class="n">mov</span> <span class="n">x28</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="nl">ffff800080011d44</span><span class="p">:</span>   <span class="n">aa1f03fd</span>    <span class="n">mov</span> <span class="n">x29</span><span class="p">,</span> <span class="n">xzr</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="nl">ffff800080011d48</span><span class="p">:</span>   <span class="n">d5384115</span>    <span class="n">mrs</span> <span class="n">x21</span><span class="p">,</span> <span class="n">sp_el0</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="nl">ffff800080011d4c</span><span class="p">:</span>   <span class="n">d000aedc</span>    <span class="n">adrp</span>    <span class="n">x28</span><span class="p">,</span> <span class="n">ffff8000815eb000</span> <span class="o">&lt;</span><span class="n">this_cpu_vector</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="nl">ffff800080011d50</span><span class="p">:</span>   <span class="mi">910</span><span class="n">c239c</span>    <span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x28</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x308</span>
</span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="nl">ffff800080011d54</span><span class="p">:</span>   <span class="n">d538d094</span>    <span class="n">mrs</span> <span class="n">x20</span><span class="p">,</span> <span class="n">tpidr_el1</span>
</span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="nl">ffff800080011d58</span><span class="p">:</span>   <span class="n">f8746b9c</span>    <span class="n">ldr</span> <span class="n">x28</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">,</span> <span class="n">x20</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="nl">ffff800080011d5c</span><span class="p">:</span>   <span class="n">d518411c</span>    <span class="n">msr</span> <span class="n">sp_el0</span><span class="p">,</span> <span class="n">x28</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="nl">ffff800080011d60</span><span class="p">:</span>   <span class="n">f9400393</span>    <span class="n">ldr</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="nl">ffff800080011d64</span><span class="p">:</span>   <span class="mi">36</span><span class="n">a800b3</span>    <span class="n">tbz</span> <span class="n">w19</span><span class="p">,</span> <span class="err">#</span><span class="mi">21</span><span class="p">,</span> <span class="n">ffff800080011d78</span> <span class="o">&lt;</span><span class="n">el0t_64_sync</span><span class="o">+</span><span class="mh">0xe8</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="nl">ffff800080011d68</span><span class="p">:</span>   <span class="n">d5300254</span>    <span class="n">mrs</span> <span class="n">x20</span><span class="p">,</span> <span class="n">mdscr_el1</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="nl">ffff800080011d6c</span><span class="p">:</span>   <span class="mf">927ff</span><span class="n">a94</span>    <span class="n">and</span> <span class="n">x20</span><span class="p">,</span> <span class="n">x20</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xfffffffffffffffe</span>
</span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="nl">ffff800080011d70</span><span class="p">:</span>   <span class="n">d5100254</span>    <span class="n">msr</span> <span class="n">mdscr_el1</span><span class="p">,</span> <span class="n">x20</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="nl">ffff800080011d74</span><span class="p">:</span>   <span class="n">d5033fdf</span>    <span class="n">isb</span>
</span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="nl">ffff800080011d78</span><span class="p">:</span>   <span class="n">f9476b80</span>    <span class="n">ldr</span> <span class="n">x0</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">,</span> <span class="err">#</span><span class="mi">3792</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="nl">ffff800080011d7c</span><span class="p">:</span>   <span class="mi">14000007</span>    <span class="n">b</span>   <span class="n">ffff800080011d98</span> <span class="o">&lt;</span><span class="n">el0t_64_sync</span><span class="o">+</span><span class="mh">0x108</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="nl">ffff800080011d80</span><span class="p">:</span>   <span class="n">b63800c0</span>    <span class="n">tbz</span> <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mi">39</span><span class="p">,</span> <span class="n">ffff800080011d98</span> <span class="o">&lt;</span><span class="n">el0t_64_sync</span><span class="o">+</span><span class="mh">0x108</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="nl">ffff800080011d84</span><span class="p">:</span>   <span class="n">d5385636</span>    <span class="n">mrs</span> <span class="n">x22</span><span class="p">,</span> <span class="n">tfsre0_el1</span>
</span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="nl">ffff800080011d88</span><span class="p">:</span>   <span class="mi">36000096</span>    <span class="n">tbz</span> <span class="n">w22</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span><span class="p">,</span> <span class="n">ffff800080011d98</span> <span class="o">&lt;</span><span class="n">el0t_64_sync</span><span class="o">+</span><span class="mh">0x108</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="nl">ffff800080011d8c</span><span class="p">:</span>   <span class="n">d2800416</span>    <span class="n">mov</span> <span class="n">x22</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x20</span>                      <span class="c1">// #32
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011d90</span><span class="p">:</span>   <span class="mi">91000397</span>    <span class="n">add</span> <span class="n">x23</span><span class="p">,</span> <span class="n">x28</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>
</span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="nl">ffff800080011d94</span><span class="p">:</span>   <span class="n">f83632ff</span>    <span class="n">stset</span>   <span class="n">x22</span><span class="p">,</span> <span class="p">[</span><span class="n">x23</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="nl">ffff800080011d98</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="nl">ffff800080011d9c</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="nl">ffff800080011da0</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="nl">ffff800080011da4</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="nl">ffff800080011da8</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="nl">ffff800080011dac</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="nl">ffff800080011db0</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="nl">ffff800080011db4</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="nl">ffff800080011db8</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="nl">ffff800080011dbc</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="nl">ffff800080011dc0</span><span class="p">:</span>   <span class="mi">1400000</span><span class="n">b</span>    <span class="n">b</span>   <span class="n">ffff800080011dec</span> <span class="o">&lt;</span><span class="n">el0t_64_sync</span><span class="o">+</span><span class="mh">0x15c</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="nl">ffff800080011dc4</span><span class="p">:</span>   <span class="n">d000aed7</span>    <span class="n">adrp</span>    <span class="n">x23</span><span class="p">,</span> <span class="n">ffff8000815eb000</span> <span class="o">&lt;</span><span class="n">this_cpu_vector</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="nl">ffff800080011dc8</span><span class="p">:</span>   <span class="mi">9100</span><span class="n">a2f7</span>    <span class="n">add</span> <span class="n">x23</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x28</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="nl">ffff800080011dcc</span><span class="p">:</span>   <span class="n">d538d096</span>    <span class="n">mrs</span> <span class="n">x22</span><span class="p">,</span> <span class="n">tpidr_el1</span>
</span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="nl">ffff800080011dd0</span><span class="p">:</span>   <span class="n">f8766af7</span>    <span class="n">ldr</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">x23</span><span class="p">,</span> <span class="n">x22</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="nl">ffff800080011dd4</span><span class="p">:</span>   <span class="n">b40000d7</span>    <span class="n">cbz</span> <span class="n">x23</span><span class="p">,</span> <span class="n">ffff800080011dec</span> <span class="o">&lt;</span><span class="n">el0t_64_sync</span><span class="o">+</span><span class="mh">0x15c</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="nl">ffff800080011dd8</span><span class="p">:</span>   <span class="n">f9400397</span>    <span class="n">ldr</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="nl">ffff800080011ddc</span><span class="p">:</span>   <span class="mi">37</span><span class="n">c80097</span>    <span class="n">tbnz</span>    <span class="n">w23</span><span class="p">,</span> <span class="err">#</span><span class="mi">25</span><span class="p">,</span> <span class="n">ffff800080011dec</span> <span class="o">&lt;</span><span class="n">el0t_64_sync</span><span class="o">+</span><span class="mh">0x15c</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="nl">ffff800080011de0</span><span class="p">:</span>   <span class="mf">32013f</span><span class="n">e0</span>    <span class="n">mov</span> <span class="n">w0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x80007fff</span>             <span class="c1">// #-2147450881
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011de4</span><span class="p">:</span>   <span class="mi">52800021</span>    <span class="n">mov</span> <span class="n">w1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1</span>                    <span class="c1">// #1
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011de8</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="nl">ffff800080011dec</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="nl">ffff800080011df0</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="nl">ffff800080011df4</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="nl">ffff800080011df8</span><span class="p">:</span>   <span class="n">d5384036</span>    <span class="n">mrs</span> <span class="n">x22</span><span class="p">,</span> <span class="n">elr_el1</span>
</span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="nl">ffff800080011dfc</span><span class="p">:</span>   <span class="n">d5384017</span>    <span class="n">mrs</span> <span class="n">x23</span><span class="p">,</span> <span class="n">spsr_el1</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="nl">ffff800080011e00</span><span class="p">:</span>   <span class="n">a90f57fe</span>    <span class="n">stp</span> <span class="n">x30</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">240</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="nl">ffff800080011e04</span><span class="p">:</span>   <span class="n">a9137fff</span>    <span class="n">stp</span> <span class="n">xzr</span><span class="p">,</span> <span class="n">xzr</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">304</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="nl">ffff800080011e08</span><span class="p">:</span>   <span class="mi">9104</span><span class="n">c3fd</span>    <span class="n">add</span> <span class="n">x29</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x130</span>
</span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="nl">ffff800080011e0c</span><span class="p">:</span>   <span class="n">a9105ff6</span>    <span class="n">stp</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">256</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="nl">ffff800080011e10</span><span class="p">:</span>   <span class="mi">12800015</span>    <span class="n">mov</span> <span class="n">w21</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xffffffff</span>                <span class="c1">// #-1
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011e14</span><span class="p">:</span>   <span class="n">b9011bf5</span>    <span class="n">str</span> <span class="n">w21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">280</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="nl">ffff800080011e18</span><span class="p">:</span>   <span class="mi">14000005</span>    <span class="n">b</span>   <span class="n">ffff800080011e2c</span> <span class="o">&lt;</span><span class="n">el0t_64_sync</span><span class="o">+</span><span class="mh">0x19c</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="nl">ffff800080011e1c</span><span class="p">:</span>   <span class="n">d5384614</span>    <span class="n">mrs</span> <span class="n">x20</span><span class="p">,</span> <span class="n">s3_0_c4_c6_0</span>
</span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="nl">ffff800080011e20</span><span class="p">:</span>   <span class="n">f90097f4</span>    <span class="n">str</span> <span class="n">x20</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">296</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="nl">ffff800080011e24</span><span class="p">:</span>   <span class="n">d2801e14</span>    <span class="n">mov</span> <span class="n">x20</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xf0</span>                      <span class="c1">// #240
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011e28</span><span class="p">:</span>   <span class="n">d5184614</span>    <span class="n">msr</span> <span class="n">s3_0_c4_c6_0</span><span class="p">,</span> <span class="n">x20</span>
</span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="nl">ffff800080011e2c</span><span class="p">:</span>   <span class="mf">910003e0</span>    <span class="n">mov</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span>
</span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="c1">/// 调用C语言处理函数
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011e30</span><span class="p">:</span>   <span class="mi">94364160</span>    <span class="n">bl</span>  <span class="n">ffff800080da23b0</span> <span class="o">&lt;</span><span class="n">el0t_64_sync_handler</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="c1">/// 中断返回
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080011e34</span><span class="p">:</span>   <span class="mi">1400030</span><span class="n">d</span>    <span class="n">b</span>   <span class="n">ffff800080012a68</span> <span class="o">&lt;</span><span class="n">ret_to_user</span><span class="o">&gt;</span>
</span></span></code></pre></div>
<h2 id="94-ret_to_kernel" data-numberify>9.4. ret_to_kernel<a class="anchor ms-1" href="#94-ret_to_kernel"></a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">ffff8000800129f0</span> <span class="o">&lt;</span><span class="n">ret_to_kernel</span><span class="o">&gt;:</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nf">ret_to_kernel</span><span class="p">()</span><span class="o">:</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">linux</span><span class="o">-</span><span class="mf">6.6</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">entry</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">606</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="nl">ffff8000800129f0</span><span class="p">:</span>   <span class="n">d5034fdf</span>    <span class="n">msr</span> <span class="n">daifset</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xf</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nl">ffff8000800129f4</span><span class="p">:</span>   <span class="mi">14000004</span>    <span class="n">b</span>   <span class="n">ffff800080012a04</span> <span class="o">&lt;</span><span class="n">ret_to_kernel</span><span class="o">+</span><span class="mh">0x14</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="nl">ffff8000800129f8</span><span class="p">:</span>   <span class="n">f94097f4</span>    <span class="n">ldr</span> <span class="n">x20</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">296</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="nl">ffff8000800129fc</span><span class="p">:</span>   <span class="n">d5184614</span>    <span class="n">msr</span> <span class="n">s3_0_c4_c6_0</span><span class="p">,</span> <span class="n">x20</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="nl">ffff800080012a00</span><span class="p">:</span>   <span class="n">d5033f9f</span>    <span class="n">dsb</span> <span class="n">sy</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="nl">ffff800080012a04</span><span class="p">:</span>   <span class="n">a9505bf5</span>    <span class="n">ldp</span> <span class="n">x21</span><span class="p">,</span> <span class="n">x22</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">256</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="nl">ffff800080012a08</span><span class="p">:</span>   <span class="n">d5184035</span>    <span class="n">msr</span> <span class="n">elr_el1</span><span class="p">,</span> <span class="n">x21</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="nl">ffff800080012a0c</span><span class="p">:</span>   <span class="n">d5184016</span>    <span class="n">msr</span> <span class="n">spsr_el1</span><span class="p">,</span> <span class="n">x22</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="nl">ffff800080012a10</span><span class="p">:</span>   <span class="n">a94007e0</span>    <span class="n">ldp</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="nl">ffff800080012a14</span><span class="p">:</span>   <span class="n">a9410fe2</span>    <span class="n">ldp</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="nl">ffff800080012a18</span><span class="p">:</span>   <span class="n">a94217e4</span>    <span class="n">ldp</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">32</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="nl">ffff800080012a1c</span><span class="p">:</span>   <span class="n">a9431fe6</span>    <span class="n">ldp</span> <span class="n">x6</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">48</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="nl">ffff800080012a20</span><span class="p">:</span>   <span class="n">a94427e8</span>    <span class="n">ldp</span> <span class="n">x8</span><span class="p">,</span> <span class="n">x9</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">64</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="nl">ffff800080012a24</span><span class="p">:</span>   <span class="n">a9452fea</span>    <span class="n">ldp</span> <span class="n">x10</span><span class="p">,</span> <span class="n">x11</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">80</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="nl">ffff800080012a28</span><span class="p">:</span>   <span class="n">a94637ec</span>    <span class="n">ldp</span> <span class="n">x12</span><span class="p">,</span> <span class="n">x13</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">96</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="nl">ffff800080012a2c</span><span class="p">:</span>   <span class="n">a9473fee</span>    <span class="n">ldp</span> <span class="n">x14</span><span class="p">,</span> <span class="n">x15</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">112</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="nl">ffff800080012a30</span><span class="p">:</span>   <span class="n">a94847f0</span>    <span class="n">ldp</span> <span class="n">x16</span><span class="p">,</span> <span class="n">x17</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">128</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="nl">ffff800080012a34</span><span class="p">:</span>   <span class="n">a9494ff2</span>    <span class="n">ldp</span> <span class="n">x18</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">144</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="nl">ffff800080012a38</span><span class="p">:</span>   <span class="n">a94a57f4</span>    <span class="n">ldp</span> <span class="n">x20</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">160</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="nl">ffff800080012a3c</span><span class="p">:</span>   <span class="n">a94b5ff6</span>    <span class="n">ldp</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">176</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="nl">ffff800080012a40</span><span class="p">:</span>   <span class="n">a94c67f8</span>    <span class="n">ldp</span> <span class="n">x24</span><span class="p">,</span> <span class="n">x25</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">192</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="nl">ffff800080012a44</span><span class="p">:</span>   <span class="n">a94d6ffa</span>    <span class="n">ldp</span> <span class="n">x26</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">208</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="nl">ffff800080012a48</span><span class="p">:</span>   <span class="n">a94e77fc</span>    <span class="n">ldp</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x29</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">224</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="nl">ffff800080012a4c</span><span class="p">:</span>   <span class="n">f9407bfe</span>    <span class="n">ldr</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">240</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="nl">ffff800080012a50</span><span class="p">:</span>   <span class="mf">910543ff</span>    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x150</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="nl">ffff800080012a54</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="c1">/// 从异常返回
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080012a58</span><span class="p">:</span>   <span class="n">d69f03e0</span>    <span class="n">eret</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="nl">ffff800080012a5c</span><span class="p">:</span>   <span class="n">d503379f</span>    <span class="n">dsb</span> <span class="n">nsh</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="nl">ffff800080012a60</span><span class="p">:</span>   <span class="n">d5033fdf</span>    <span class="n">isb</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="nl">ffff800080012a64</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span></code></pre></div>
<h2 id="95-ret_to_user" data-numberify>9.5. ret_to_user<a class="anchor ms-1" href="#95-ret_to_user"></a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">ffff800080012a68</span> <span class="o">&lt;</span><span class="n">ret_to_user</span><span class="o">&gt;:</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nf">ret_to_user</span><span class="p">()</span><span class="o">:</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">linux</span><span class="o">-</span><span class="mf">6.6</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">entry</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">610</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="nl">ffff800080012a68</span><span class="p">:</span>   <span class="n">f9400393</span>    <span class="n">ldr</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">linux</span><span class="o">-</span><span class="mf">6.6</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">entry</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">611</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="nl">ffff800080012a6c</span><span class="p">:</span>   <span class="mi">36</span><span class="n">a80093</span>    <span class="n">tbz</span> <span class="n">w19</span><span class="p">,</span> <span class="err">#</span><span class="mi">21</span><span class="p">,</span> <span class="n">ffff800080012a7c</span> <span class="o">&lt;</span><span class="n">ret_to_user</span><span class="o">+</span><span class="mh">0x14</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="nl">ffff800080012a70</span><span class="p">:</span>   <span class="n">d5300242</span>    <span class="n">mrs</span> <span class="n">x2</span><span class="p">,</span> <span class="n">mdscr_el1</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="nl">ffff800080012a74</span><span class="p">:</span>   <span class="n">b2400042</span>    <span class="n">orr</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="nl">ffff800080012a78</span><span class="p">:</span>   <span class="n">d5100242</span>    <span class="n">msr</span> <span class="n">mdscr_el1</span><span class="p">,</span> <span class="n">x2</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">linux</span><span class="o">-</span><span class="mf">6.6</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">entry</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">615</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="nl">ffff800080012a7c</span><span class="p">:</span>   <span class="mi">14000004</span>    <span class="n">b</span>   <span class="n">ffff800080012a8c</span> <span class="o">&lt;</span><span class="n">ret_to_user</span><span class="o">+</span><span class="mh">0x24</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="nl">ffff800080012a80</span><span class="p">:</span>   <span class="n">f94097f4</span>    <span class="n">ldr</span> <span class="n">x20</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">296</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="nl">ffff800080012a84</span><span class="p">:</span>   <span class="n">d5184614</span>    <span class="n">msr</span> <span class="n">s3_0_c4_c6_0</span><span class="p">,</span> <span class="n">x20</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="nl">ffff800080012a88</span><span class="p">:</span>   <span class="n">d5033f9f</span>    <span class="n">dsb</span> <span class="n">sy</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="nl">ffff800080012a8c</span><span class="p">:</span>   <span class="n">a9505bf5</span>    <span class="n">ldp</span> <span class="n">x21</span><span class="p">,</span> <span class="n">x22</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">256</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="nl">ffff800080012a90</span><span class="p">:</span>   <span class="n">f9407ff7</span>    <span class="n">ldr</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">248</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="nl">ffff800080012a94</span><span class="p">:</span>   <span class="n">d5184117</span>    <span class="n">msr</span> <span class="n">sp_el0</span><span class="p">,</span> <span class="n">x23</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="nl">ffff800080012a98</span><span class="p">:</span>   <span class="n">f27c02df</span>    <span class="n">tst</span> <span class="n">x22</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x10</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="nl">ffff800080012a9c</span><span class="p">:</span>   <span class="mi">54000020</span>    <span class="n">b</span><span class="p">.</span><span class="n">eq</span>    <span class="n">ffff800080012aa0</span> <span class="o">&lt;</span><span class="n">ret_to_user</span><span class="o">+</span><span class="mh">0x38</span><span class="o">&gt;</span>  <span class="c1">// b.none
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080012aa0</span><span class="p">:</span>   <span class="n">f9476b80</span>    <span class="n">ldr</span> <span class="n">x0</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">,</span> <span class="err">#</span><span class="mi">3792</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="nl">ffff800080012aa4</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="nl">ffff800080012aa8</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="nl">ffff800080012aac</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="nl">ffff800080012ab0</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="nl">ffff800080012ab4</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="nl">ffff800080012ab8</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="nl">ffff800080012abc</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="nl">ffff800080012ac0</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="nl">ffff800080012ac4</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="nl">ffff800080012ac8</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="nl">ffff800080012acc</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="nl">ffff800080012ad0</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="nl">ffff800080012ad4</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="nl">ffff800080012ad8</span><span class="p">:</span>   <span class="mi">1400000</span><span class="n">b</span>    <span class="n">b</span>   <span class="n">ffff800080012b04</span> <span class="o">&lt;</span><span class="n">ret_to_user</span><span class="o">+</span><span class="mh">0x9c</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="nl">ffff800080012adc</span><span class="p">:</span>   <span class="n">b000aec1</span>    <span class="n">adrp</span>    <span class="n">x1</span><span class="p">,</span> <span class="n">ffff8000815eb000</span> <span class="o">&lt;</span><span class="n">this_cpu_vector</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="nl">ffff800080012ae0</span><span class="p">:</span>   <span class="mi">9100</span><span class="n">a021</span>    <span class="n">add</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x28</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="nl">ffff800080012ae4</span><span class="p">:</span>   <span class="n">d538d080</span>    <span class="n">mrs</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tpidr_el1</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="nl">ffff800080012ae8</span><span class="p">:</span>   <span class="n">f8606821</span>    <span class="n">ldr</span> <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="nl">ffff800080012aec</span><span class="p">:</span>   <span class="n">b40000c1</span>    <span class="n">cbz</span> <span class="n">x1</span><span class="p">,</span> <span class="n">ffff800080012b04</span> <span class="o">&lt;</span><span class="n">ret_to_user</span><span class="o">+</span><span class="mh">0x9c</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="nl">ffff800080012af0</span><span class="p">:</span>   <span class="n">f9400381</span>    <span class="n">ldr</span> <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="nl">ffff800080012af4</span><span class="p">:</span>   <span class="mi">37</span><span class="n">c80081</span>    <span class="n">tbnz</span>    <span class="n">w1</span><span class="p">,</span> <span class="err">#</span><span class="mi">25</span><span class="p">,</span> <span class="n">ffff800080012b04</span> <span class="o">&lt;</span><span class="n">ret_to_user</span><span class="o">+</span><span class="mh">0x9c</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="nl">ffff800080012af8</span><span class="p">:</span>   <span class="mf">32013f</span><span class="n">e0</span>    <span class="n">mov</span> <span class="n">w0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x80007fff</span>             <span class="c1">// #-2147450881
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080012afc</span><span class="p">:</span>   <span class="mi">52800001</span>    <span class="n">mov</span> <span class="n">w1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>                    <span class="c1">// #0
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080012b00</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="nl">ffff800080012b04</span><span class="p">:</span>   <span class="n">d5184035</span>    <span class="n">msr</span> <span class="n">elr_el1</span><span class="p">,</span> <span class="n">x21</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="nl">ffff800080012b08</span><span class="p">:</span>   <span class="n">d5184016</span>    <span class="n">msr</span> <span class="n">spsr_el1</span><span class="p">,</span> <span class="n">x22</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="nl">ffff800080012b0c</span><span class="p">:</span>   <span class="n">a94007e0</span>    <span class="n">ldp</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="nl">ffff800080012b10</span><span class="p">:</span>   <span class="n">a9410fe2</span>    <span class="n">ldp</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="nl">ffff800080012b14</span><span class="p">:</span>   <span class="n">a94217e4</span>    <span class="n">ldp</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">32</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="nl">ffff800080012b18</span><span class="p">:</span>   <span class="n">a9431fe6</span>    <span class="n">ldp</span> <span class="n">x6</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">48</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="nl">ffff800080012b1c</span><span class="p">:</span>   <span class="n">a94427e8</span>    <span class="n">ldp</span> <span class="n">x8</span><span class="p">,</span> <span class="n">x9</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">64</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="nl">ffff800080012b20</span><span class="p">:</span>   <span class="n">a9452fea</span>    <span class="n">ldp</span> <span class="n">x10</span><span class="p">,</span> <span class="n">x11</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">80</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="nl">ffff800080012b24</span><span class="p">:</span>   <span class="n">a94637ec</span>    <span class="n">ldp</span> <span class="n">x12</span><span class="p">,</span> <span class="n">x13</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">96</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="nl">ffff800080012b28</span><span class="p">:</span>   <span class="n">a9473fee</span>    <span class="n">ldp</span> <span class="n">x14</span><span class="p">,</span> <span class="n">x15</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">112</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="nl">ffff800080012b2c</span><span class="p">:</span>   <span class="n">a94847f0</span>    <span class="n">ldp</span> <span class="n">x16</span><span class="p">,</span> <span class="n">x17</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">128</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="nl">ffff800080012b30</span><span class="p">:</span>   <span class="n">a9494ff2</span>    <span class="n">ldp</span> <span class="n">x18</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">144</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="nl">ffff800080012b34</span><span class="p">:</span>   <span class="n">a94a57f4</span>    <span class="n">ldp</span> <span class="n">x20</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">160</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="nl">ffff800080012b38</span><span class="p">:</span>   <span class="n">a94b5ff6</span>    <span class="n">ldp</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">176</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="nl">ffff800080012b3c</span><span class="p">:</span>   <span class="n">a94c67f8</span>    <span class="n">ldp</span> <span class="n">x24</span><span class="p">,</span> <span class="n">x25</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">192</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="nl">ffff800080012b40</span><span class="p">:</span>   <span class="n">a94d6ffa</span>    <span class="n">ldp</span> <span class="n">x26</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">208</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="nl">ffff800080012b44</span><span class="p">:</span>   <span class="n">a94e77fc</span>    <span class="n">ldp</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x29</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">224</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="nl">ffff800080012b48</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="nl">ffff800080012b4c</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="nl">ffff800080012b50</span><span class="p">:</span>   <span class="n">f9407bfe</span>    <span class="n">ldr</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">240</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="nl">ffff800080012b54</span><span class="p">:</span>   <span class="mf">910543ff</span>    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x150</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="c1">/// 从异常返回
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080012b58</span><span class="p">:</span>   <span class="n">d69f03e0</span>    <span class="n">eret</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="cp">#ifdef CONFIG_UNMAP_KERNEL_AT_EL0
</span></span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="cp"></span><span class="nl">ffff800080012b5c</span><span class="p">:</span>   <span class="n">d518601d</span>    <span class="n">msr</span> <span class="n">far_el1</span><span class="p">,</span> <span class="n">x29</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="nl">ffff800080012b60</span><span class="p">:</span>   <span class="n">b000aede</span>    <span class="n">adrp</span>    <span class="n">x30</span><span class="p">,</span> <span class="n">ffff8000815eb000</span> <span class="o">&lt;</span><span class="n">this_cpu_vector</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="nl">ffff800080012b64</span><span class="p">:</span>   <span class="mi">910003</span><span class="n">de</span>    <span class="n">add</span> <span class="n">x30</span><span class="p">,</span> <span class="n">x30</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>
</span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="nl">ffff800080012b68</span><span class="p">:</span>   <span class="n">d538d09d</span>    <span class="n">mrs</span> <span class="n">x29</span><span class="p">,</span> <span class="n">tpidr_el1</span>
</span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="nl">ffff800080012b6c</span><span class="p">:</span>   <span class="n">f87d6bde</span>    <span class="n">ldr</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">x30</span><span class="p">,</span> <span class="n">x29</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="nl">ffff800080012b70</span><span class="p">:</span>   <span class="mi">92</span><span class="n">c0801d</span>    <span class="n">mov</span> <span class="n">x29</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xfffffbffffffffff</span>        <span class="c1">// #-4398046511105
</span></span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="c1"></span><span class="nl">ffff800080012b74</span><span class="p">:</span>   <span class="n">f2bfbbfd</span>    <span class="n">movk</span>    <span class="n">x29</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xfddf</span><span class="p">,</span> <span class="n">lsl</span> <span class="err">#</span><span class="mi">16</span>
</span></span><span class="line"><span class="ln">76</span><span class="cl"><span class="nl">ffff800080012b78</span><span class="p">:</span>   <span class="n">f290001d</span>    <span class="n">movk</span>    <span class="n">x29</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x8000</span>
</span></span><span class="line"><span class="ln">77</span><span class="cl"><span class="nl">ffff800080012b7c</span><span class="p">:</span>   <span class="n">d518c01e</span>    <span class="n">msr</span> <span class="n">vbar_el1</span><span class="p">,</span> <span class="n">x30</span>
</span></span><span class="line"><span class="ln">78</span><span class="cl"><span class="nl">ffff800080012b80</span><span class="p">:</span>   <span class="n">f9407bfe</span>    <span class="n">ldr</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">240</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">79</span><span class="cl"><span class="nl">ffff800080012b84</span><span class="p">:</span>   <span class="mf">910543ff</span>    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x150</span>
</span></span><span class="line"><span class="ln">80</span><span class="cl"><span class="nl">ffff800080012b88</span><span class="p">:</span>   <span class="n">d61f03a0</span>    <span class="n">br</span>  <span class="n">x29</span>
</span></span><span class="line"><span class="ln">81</span><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="ln">82</span><span class="cl"><span class="cp"></span><span class="nl">ffff800080012b8c</span><span class="p">:</span>   <span class="n">d503379f</span>    <span class="n">dsb</span> <span class="n">nsh</span>
</span></span><span class="line"><span class="ln">83</span><span class="cl"><span class="nl">ffff800080012b90</span><span class="p">:</span>   <span class="n">d5033fdf</span>    <span class="n">isb</span>
</span></span><span class="line"><span class="ln">84</span><span class="cl"><span class="nl">ffff800080012b94</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span><span class="line"><span class="ln">85</span><span class="cl"><span class="nl">ffff800080012b98</span><span class="p">:</span>   <span class="n">d503201f</span>    <span class="n">nop</span>
</span></span></code></pre></div>
<h1 id="10-参考资料" data-numberify>10. 参考资料<a class="anchor ms-1" href="#10-参考资料"></a></h1>
<ol>
<li><a href="https://developer.arm.com/documentation/ddi0487/latest/" target="_blank" rel="noopener noreferrer">Arm Architecture Reference Manual for A-profile architecture<i class="fas fa-external-link-square-alt ms-1"></i></a></li>
<li><a href="https://developer.arm.com/documentation/" target="_blank" rel="noopener noreferrer">Learn the architecture - AArch64 Exception Model<i class="fas fa-external-link-square-alt ms-1"></i></a></li>
<li><a href="https://blog.csdn.net/weixin_42135087/article/details/120232101" target="_blank" rel="noopener noreferrer">Linux Kernel 5.14 arm64异常向量表解读-中断处理解读<i class="fas fa-external-link-square-alt ms-1"></i></a></li>
<li><a href="https://blog.csdn.net/weixin_39592381/article/details/135079324" target="_blank" rel="noopener noreferrer">ARM架构学习（1）——Exception level<i class="fas fa-external-link-square-alt ms-1"></i></a></li>
</ol>
</div>
</div>
</div><div class="card-footer">
  <div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-prev">
      <i class="fas fa-fw fa-chevron-down post-prev-icon me-1" data-fa-transform="rotate-90"></i>
      <a href="/zh-cn/docs/04-kernel/linux-6.6/kdump_crash/arm64_setup/">ARM64 Crash调试环境搭建</a>
    </div><div class="post-nav post-next">
      <a href="/zh-cn/docs/04-kernel/linux-6.6/syscall/syscall/">【Linux内核|系统调用】深度分析系统调用从用户程序到内核的流程</a>
      <i class="fas fa-fw fa-chevron-down post-next-icon ms-1" data-fa-transform="rotate-270"></i>
    </div></div>
</div></article><div class="post-copyright mb-3 row card component" id="post-copyright">
    <div class="card-header">
        <h2 class="card-title fs-4 my-2 text-surface">版权</h2>
    </div>
    <div class="card-body"><a class="d-flex align-items-center flex-column" target="_blank" rel="license noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh">
  <span><i class="fab fa-fw fa-2x fa-creative-commons"></i><i class="fab fa-fw fa-2x fa-creative-commons-by"></i><i class="fab fa-fw fa-2x fa-creative-commons-nc"></i><i class="fab fa-fw fa-2x fa-creative-commons-nd"></i></span>
  CC BY-NC-ND 4.0 
</a>


    </div>
</div><section class="related-posts row card component">
      <div class="card-header">
        <h2 class="card-title fs-4 my-2 text-surface">
          相关文章
        </h2>
      </div>
      <div class="card-body slide px-1">
        <div class="slide-inner row gx-0"><div class="col-12 col-md-6 col-lg-4 me-2">
            <div class="post-card card card-body p-0 border-0 surface">
  
  <picture><img class="img-fluid" alt="Linux ARM64页面大小和虚拟地址位数" src="https://kingdix10.github.io/covers/neon_lights_dark_133133_300x168.jpg" loading="lazy"
     width="300"
     height="168"/>
  </picture>

  <a class="post-title" href="/zh-cn/docs/04-kernel/linux-6.6/mm/arm64_pgtabl/">
    Linux ARM64页面大小和虚拟地址位数
  </a>
  <div class="post-meta mb-0">
    2022/04/05

  </div>
</div>

          </div><div class="col-12 col-md-6 col-lg-4 me-2">
            <div class="post-card card card-body p-0 border-0 surface">
  
  <picture><img class="img-fluid" alt="Linux内核sched_class汇总" src="https://kingdix10.github.io/covers/camera_photographer_smoke_126548_300x168.jpg" loading="lazy"
     width="300"
     height="168"/>
  </picture>

  <a class="post-title" href="/zh-cn/docs/04-kernel/linux-6.6/sched/sched_class_tabl/">
    Linux内核sched_class汇总
  </a>
  <div class="post-meta mb-0">
    2022/02/22

  </div>
</div>

          </div><div class="col-12 col-md-6 col-lg-4 me-2">
            <div class="post-card card card-body p-0 border-0 surface">
  
  <picture><img class="img-fluid" alt="Linux进程状态与生命周期" src="https://kingdix10.github.io/covers/walls_floor_light_50837_300x168.jpg" loading="lazy"
     width="300"
     height="168"/>
  </picture>

  <a class="post-title" href="/zh-cn/docs/04-kernel/linux-6.6/sched/07-task_stat/">
    Linux进程状态与生命周期
  </a>
  <div class="post-meta mb-0">
    2022/02/18

  </div>
</div>

          </div><div class="col-12 col-md-6 col-lg-4 me-2">
            <div class="post-card card card-body p-0 border-0 surface">
  
  <picture><img class="img-fluid" alt="Linux内核copy_process分析（三）" src="https://kingdix10.github.io/covers/iridescent_colorful_lines_130978_300x168.jpg" loading="lazy"
     width="300"
     height="168"/>
  </picture>

  <a class="post-title" href="/zh-cn/docs/04-kernel/linux-6.6/sched/06-b-copy_process_3/">
    Linux内核copy_process分析（三）
  </a>
  <div class="post-meta mb-0">
    2022/02/15

  </div>
</div>

          </div><div class="col-12 col-md-6 col-lg-4 me-2">
            <div class="post-card card card-body p-0 border-0 surface">
  
  <picture><img class="img-fluid" alt="Linux内核copy_process分析（二）" src="https://kingdix10.github.io/covers/leaves_patterns_texture_127524_300x168.jpg" loading="lazy"
     width="300"
     height="168"/>
  </picture>

  <a class="post-title" href="/zh-cn/docs/04-kernel/linux-6.6/sched/06-b-copy_process_2/">
    Linux内核copy_process分析（二）
  </a>
  <div class="post-meta mb-0">
    2022/02/14

  </div>
</div>

          </div></div>
        <button class="slide-control-left">
          <i class="fas fa-2x fa-chevron-circle-down" data-fa-transform="rotate-90"></i>
          <span class="visually-hidden">Left</span>
        </button>
        <button class="slide-control-right">
          <i class="fas fa-2x fa-chevron-circle-down" data-fa-transform="rotate-270"></i>
          <span class="visually-hidden">Right</span>
        </button>
      </div>
    </section></div>
</div>
<aside class="sidebar d-flex docs-sidebar col-xxl-3 position-sticky order-xxl-5">
  <div class="container">
    
<div class="row component card">
    <div class="card-body">
        <form action="/zh-cn/search/">
            <div class="input-group">
                <input name="q" class="form-control rounded" placeholder="搜索">
                <button class="btn btn-sm btn-search position-absolute end-0 border-0 border-start border-secondary p-2" type="submit">
                    <i class="fas fa-fw fa-search text-primary"></i>
                </button>
            </div>
        </form>
    </div>
</div>


    <div class="accordion post-toc d-none d-lg-block">
  <div class="accordion-item row mb-4 card component" id="postTOC">
    <div class="card-header accordion-header">
      <h2 class="card-title fs-4 my-2 text-surface d-none d-lg-block">目录</h2>
      <a class="accordion-button d-lg-none mb-1 collapsed shadow-none p-0 bg-transparent" role="button" data-bs-toggle="collapse" href="#post-toc" aria-expanded="false" aria-controls="post-toc">
        目录
      </a>
    </div>
    <div class="card-body collapse accordion-collapse accordion-body d-lg-block" id="post-toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#1-简介">1. 简介</a>
      <ul>
        <li><a href="#11-中断向量基地址寄存器配置">1.1. 中断向量基地址寄存器配置</a></li>
      </ul>
    </li>
    <li><a href="#2-中断向量表">2. 中断向量表</a></li>
    <li><a href="#3-linux内核的中断入口">3. Linux内核的中断入口</a>
      <ul>
        <li><a href="#31-硬件的工作">3.1. 硬件的工作</a></li>
      </ul>
    </li>
    <li><a href="#4-中断入口定义kernel_ventry">4. 中断入口定义：kernel_ventry</a>
      <ul>
        <li><a href="#41-entry_handler">4.1. entry_handler</a></li>
        <li><a href="#42-调用c函数前的准备kernel_entry">4.2. 调用C函数前的准备kernel_entry</a>
          <ul>
            <li><a href="#421-寄存器压栈">4.2.1. 寄存器压栈</a></li>
            <li><a href="#422-el0和el1的处理">4.2.2. el0和el1的处理</a>
              <ul>
                <li><a href="#4221-el0">4.2.2.1. EL0</a></li>
                <li><a href="#4222-el1">4.2.2.2. EL1</a></li>
              </ul>
            </li>
            <li><a href="#423-寄存和栈配置">4.2.3. 寄存和栈配置</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#5-中断处理c语言函数">5. 中断处理C语言函数</a>
      <ul>
        <li><a href="#51-unhandled">5.1. UNHANDLED</a></li>
      </ul>
    </li>
    <li><a href="#6-中断返回">6. 中断返回</a>
      <ul>
        <li><a href="#61-ret_to_kernel">6.1. ret_to_kernel</a></li>
        <li><a href="#62-ret_to_user">6.2. ret_to_user</a></li>
      </ul>
    </li>
    <li><a href="#7-kernel_exit">7. kernel_exit</a>
      <ul>
        <li><a href="#71-el0关闭daif">7.1. el0关闭daif</a></li>
        <li><a href="#72-从elr和spsr恢复">7.2. 从ELR和SPSR恢复</a></li>
        <li><a href="#73-el0栈空间处理">7.3. el0栈空间处理</a></li>
        <li><a href="#74-寄存器出栈">7.4. 寄存器出栈</a></li>
        <li><a href="#75-el0和el1恢复">7.5. el0和el1恢复</a>
          <ul>
            <li><a href="#751-el0">7.5.1. el0</a></li>
            <li><a href="#752-el1">7.5.2. el1</a></li>
          </ul>
        </li>
        <li><a href="#76-speculation-barrier">7.6. Speculation barrier</a></li>
      </ul>
    </li>
    <li><a href="#8-总结">8. 总结</a>
      <ul>
        <li><a href="#81-daif状态切换">8.1. daif状态切换</a></li>
        <li><a href="#82-sp和current">8.2. SP和current</a></li>
      </ul>
    </li>
    <li><a href="#9-反汇编">9. 反汇编</a>
      <ul>
        <li><a href="#91-vectors">9.1. vectors</a></li>
        <li><a href="#92-el1t_64_sync和el1t_64_irq">9.2. el1t_64_sync和el1t_64_irq</a></li>
        <li><a href="#93-el0t_64_sync">9.3. el0t_64_sync</a></li>
        <li><a href="#94-ret_to_kernel">9.4. ret_to_kernel</a></li>
        <li><a href="#95-ret_to_user">9.5. ret_to_user</a></li>
      </ul>
    </li>
    <li><a href="#10-参考资料">10. 参考资料</a></li>
  </ul>
</nav>
    </div>
  </div>
</div>
    






  </div>
</aside>

      </div>
    </main><footer class="footer mt-auto py-3 text-center container"><div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="offcanvasActionsPanel"
  aria-labelledby="offcanvasActionsPanelLabel">
  <div class="offcanvas-header">
    <div class="offcanvas-title h5" id="offcanvasActionsPanelLabel">
      <i class="fas fa-fw fa-th-large me-1"></i>
      操作
    </div>
    <button type="button" class="btn-close ms-auto" data-bs-dismiss="offcanvas" data-bs-target="offcanvasActionsPanel" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body mt-2"><div class="actions d-flex overflow-auto align-items-center">
      <a role="button" class="action action-go-back d-flex flex-column align-items-center me-3" href="javascript: window.history.back();">
        <span class="action-icon mb-2"><i class="fas fa-2x fa-chevron-circle-down" data-fa-transform="rotate-90"></i></span> 返回
      </a>
      <a role="button" class="action action-reload-page d-flex flex-column align-items-center me-3">
        <span class="action-icon mb-2"><i class="fas fa-2x fa-redo-alt"></i></span> 刷新
      </a>
      <a role="button" class="action action-copy-url d-flex flex-column align-items-center me-3">
        <span class="action-icon mb-2"><i class="fas fa-2x fa-link"></i></span> 复制链接
      </a>
    </div>
  </div>
</div><div class="row text-center text-lg-start">
  <div class="col-12 mt-2 col-lg-3">
    <p class="mb-2">kingdix10&#39;s site</p>
    <p class="text-secondary mb-2"><small>kingdix10 @ 拾月国度</small></p><div class="copyright mb-2 text-secondary">
  <small>Copyright ? 2018-2024 kingdix10. All Rights Reserved.
</small>
</div>



<nav class="social-links nav justify-content-center justify-content-between mb-2 mt-3">
      <a class="nav-link social-link p-0 me-1 mb-2" target="_blank" href="https://github.com/kingdix10" title="GitHub" rel="me">
        <i class="fa-fw fab fa-github"
          ></i>
      </a>
      <a class="nav-link social-link p-0 me-1 mb-2" target="_blank" href="https://www.zhihu.com/people/kingdix10" title="知乎" rel="me">
        <i class="fa-fw fab fa-zhihu"
           style="color: #056de8;"></i>
      </a>
  <a class="nav-link social-link p-0 me-1 mb-2" target="_blank" href="/zh-cn/index.xml" title="RSS" rel="me">
    <i class="fas fa-fw fa-rss" style="color: #ea6221;"></i>
  </a>
</nav>
</div>
  <div class="col-12 col-lg-8 offset-0 offset-lg-1"><ul class="nav justify-content-between footer-memu mb-3 row"><li class="nav-item col-12 col-md-6 col-lg-3 px-0"><ul class="nav flex-column align-items-start">
      <li class="nav-item w-100"><a class="nav-link fw-bold fs-lg" href="javascript: void(0);">链接</a></li><li class="nav-item w-100"><a class="nav-link text-nowrap overflow-hidden" title="
GitHub"
  href="https://github.com/kingdix10" target="_blank" rel="noopener noreferrer">
<span class="menu-icon me-1"><i class="fab fa-fw fa-github text-primary"></i></span>GitHub</a></li><li class="nav-item w-100"><a class="nav-link text-nowrap overflow-hidden" title="
Gitee"
  href="https://gitee.com/kingdix10" target="_blank" rel="noopener noreferrer">
<span class="menu-icon me-1"><i class="fab fa-fw fa-github text-primary"></i></span>Gitee</a></li><li class="nav-item w-100"><a class="nav-link text-nowrap overflow-hidden" title="
Zhihu"
  href="https://www.zhihu.com/people/kingdix10" target="_blank" rel="noopener noreferrer">
<span class="menu-icon me-1"><i class="fab fa-fw fa-zhihu text-primary"></i></span>Zhihu</a></li></ul></li></ul></div>
</div>
</footer>
<script data-precache src="/assets/main/bundle.min.01351680f89e0e34293b6918c75261e88f5ff72804497fa7dea58b4190d564e6.js" integrity="sha256-ATUWgPieDjQpO2kYx1Jh6I9f9ygESX&#43;n3qWLQZDVZOY=" crossorigin="anonymous" async></script><script data-precache src="/assets/icons/bundle.min.13ec5d94691ffeccc1199f2bd83b57c09206a03a6a25f696c572a1461d58b674.js" integrity="sha256-E&#43;xdlGkf/szBGZ8r2DtXwJIGoDpqJfaWxXKhRh1YtnQ=" crossorigin="anonymous" defer></script>
<script data-precache src="/assets/viewer/bundle.min.ffafad0d121aa7d1fb443510086dac514a0b152826cf094f02a1f3dec1f37918.js" integrity="sha256-/6&#43;tDRIap9H7RDUQCG2sUUoLFSgmzwlPAqHz3sHzeRg=" crossorigin="anonymous" defer></script><script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?8e042c957455c462d9b4c9da3ab642b0";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
<script src="/js/sw-register.js" defer></script>

  </body>
</html>
